# 2.6 系統架構

本研究開發了一個基於 Model Context Protocol (MCP) 的智慧物體偵測系統，整合了 YOLOv8 深度學習模型、ESP32-CAM 硬體設備與 Claude Desktop 人工智慧助理，實現即時的物體偵測與追蹤功能。系統採用模組化設計，透過標準化的通訊協議確保各組件之間的高效協作。

## 2.6.1 整體架構設計

系統採用三層式架構設計，如圖 X 所示，由上而下分別為使用者介面層、協議通訊層與硬體感知層。使用者透過 Claude Desktop 作為操作介面，以自然語言方式呼叫物體偵測功能。Claude Desktop 接收到使用者的指令後，會透過 Model Context Protocol 協議層與本地的 Python 服務程式進行通訊。該服務程式（mcpclient.py）作為系統的核心處理單元，負責連接 ESP32-CAM 硬體設備、執行 YOLOv8 模型推論，以及進行物體追蹤等運算工作。最底層的 ESP32-CAM 則負責即時擷取環境影像，並透過區域網路以 MJPEG 格式持續傳送視訊串流。

整個系統的資料流動呈現雙向循環的特性。當使用者發起偵測請求時，Claude Desktop 會將請求封裝為 JSON-RPC 格式的訊息，透過標準輸入（stdin）傳送給 MCP 服務程式。服務程式解析請求後，建立與 ESP32-CAM 的 HTTP 連線並擷取影像幀。接著，OpenCV 函式庫負責解碼 MJPEG 視訊流，將影像資料轉換為可供深度學習模型處理的格式。YOLOv8 模型在 GPU 或 CPU 上執行物體偵測推論，識別出影像中的物體類別、位置與信心度。為了提升偵測結果的穩定性，系統進一步採用 Kalman Filter 演算法進行物體追蹤，減少檢測框的閃爍現象並維持物體的連續性。處理完成後，系統將偵測結果繪製於原始影像上，經過 JPEG 編碼與 Base64 轉換後，連同偵測統計資訊一併封裝為 JSON 格式，透過標準輸出（stdout）回傳給 Claude Desktop，最終呈現於使用者面前。

## 2.6.2 關鍵技術組件

### Model Context Protocol (MCP) 框架

本研究採用 Model Context Protocol 作為系統通訊的核心協議。MCP 是一種基於 JSON-RPC 2.0 的標準化通訊協定，透過標準輸入/輸出（stdio）進行程序間通訊。相較於傳統的 HTTP API 架構，MCP 協議具有更低的通訊延遲與更簡潔的實作方式。系統使用 FastMCP 框架實作 MCP 服務端，透過 Python 裝飾器（@mcp.tool()）將物體偵測功能註冊為可呼叫的工具。該框架自動處理參數解析、型別驗證與 JSON 序列化等繁瑣工作，使開發者能夠專注於核心業務邏輯的實作。

MCP 服務程式在啟動時會初始化 YOLOv8 模型並自動偵測運算設備，若系統配備 CUDA 相容的 GPU，模型會自動轉移至 GPU 記憶體以加速推論過程。服務程式共註冊了四個工具函數：detect_esp32_stream() 提供完整的串流偵測與追蹤功能、detect_stream_frame_simple() 提供簡化版的快速偵測、check_stream_health() 用於診斷串流連線狀態，以及 detect_image() 處理靜態圖片的偵測需求。每個工具都具備詳細的參數設定選項，允許使用者根據不同應用場景調整偵測的精確度、處理速度與追蹤穩定性。

### YOLOv8 物體偵測模型

系統採用 YOLOv8（You Only Look Once version 8）作為物體偵測的核心演算法。YOLOv8 是目前最先進的即時物體偵測模型之一，具備高準確度與快速推論的特性。本研究使用客製化訓練的 YOLOv8 模型（best.pt），針對特定物體類別進行優化訓練。模型在接收到影像幀後，會自動將影像縮放至指定的推論尺寸（預設為 416×416 像素），執行前向傳播運算，並輸出包含邊界框座標、物體類別與信心度的檢測結果。

為了平衡偵測精確度與運算效率，系統提供了多項可調整參數。信心度閾值（conf）用於過濾低可信度的檢測結果，預設設定為 0.25，可根據應用需求調整至 0.15（高召回率）或 0.5（高精確度）之間。影像尺寸參數（imgsz）影響模型的推論速度與準確度，較大的尺寸能提供更精確的檢測但會增加運算時間。系統在 GPU 加速下，單幀的 YOLO 推論時間約為 150 毫秒，而在 CPU 上則需約 800 毫秒，顯示出 GPU 加速的重要性。

### Kalman Filter 物體追蹤

為了改善即時偵測系統中常見的檢測框閃爍問題，本研究實作了基於 Kalman Filter 的物體追蹤演算法。Kalman Filter 是一種遞迴式最優估計演算法，能夠根據過去的觀測值與當前的測量值，預測物體的未來狀態。系統使用四維狀態空間（x, y, vx, vy）來表示物體的位置與速度，並使用二維測量空間（x, y）來更新物體的中心座標。

追蹤流程包含預測、匹配與更新三個階段。在預測階段，Kalman Filter 根據物體的歷史運動軌跡預測其在當前幀的可能位置。匹配階段則計算 YOLO 新檢測到的物體與現有追蹤物體之間的歐式距離，採用最近鄰演算法進行數據關聯。若匹配成功，系統會更新 Kalman Filter 的狀態並重置物體的年齡（age）；若檢測到新物體，則建立新的追蹤器；若既有物體未被匹配，其年齡會遞增，當年齡超過設定的閾值（max_age，預設為 5）時，該物體會被移除。此外，系統引入了顯示容忍度（display_tolerance）機制，只顯示年齡小於此閾值的物體，有效降低了偵測結果的閃爍現象，提升了視覺上的穩定性。

### ESP32-CAM 視訊擷取

硬體層採用 ESP32-CAM 模組作為視訊擷取設備。ESP32-CAM 整合了 ESP32 微控制器與 OV2640 攝像頭模組，具備 WiFi 無線網路功能，能夠透過區域網路以 MJPEG（Motion JPEG）格式串流即時影像。該模組支援多種解析度設定，從 160×120 的 QQVGA 到 1600×1200 的 UXGA，本系統常用的設定為 640×480 的 VGA 解析度，在影像品質與網路傳輸效率之間取得平衡。

系統透過 OpenCV 的 VideoCapture 類別建立與 ESP32-CAM 的 HTTP 串流連線（http://192.168.0.103:81/stream）。為了降低延遲，系統將 OpenCV 的緩衝區大小設定為 1，確保每次讀取的都是最新的影像幀。此外，系統提供了幀跳過（frame_skip）功能，允許使用者根據運算資源與即時性需求調整處理頻率。例如，設定 frame_skip=5 可將 30 FPS 的串流降至約 6 FPS 的處理速度，在降低運算負擔的同時仍能維持足夠的監控即時性。

## 2.6.3 系統運作流程

完整的系統運作流程可分為六個主要階段。首先，使用者在 Claude Desktop 介面中以自然語言輸入指令，例如「使用 detect_esp32_stream 工具偵測畫面」。Claude Desktop 解析使用者意圖後，將其轉換為標準的 JSON-RPC 請求訊息，包含工具名稱、參數設定等資訊，並透過子程序的標準輸入傳送給 MCP 服務程式。

第二階段，MCP 服務程式的 FastMCP 框架接收並解析 JSON-RPC 請求，根據工具名稱路由至對應的 Python 函數，並進行參數型別驗證與預設值填充。第三階段，服務程式使用 OpenCV 建立與 ESP32-CAM 的 HTTP 連線，持續讀取 MJPEG 視訊流。根據 frame_skip 參數設定，系統可能會跳過部分影像幀以控制處理速度。

第四階段進入影像處理與推論流程。OpenCV 將 MJPEG 格式的影像解碼為 numpy 陣列，並將資料複製至 GPU 記憶體（若可用）。YOLOv8 模型執行前向傳播運算，識別出影像中的物體並輸出檢測結果。若啟用 Kalman Filter 追蹤功能，系統會進行物體匹配與狀態更新，確保檢測結果的連續性與穩定性。隨後，系統使用 OpenCV 的繪圖函數在原始影像上繪製邊界框與物體標籤，生成標註後的影像。

第五階段為結果編碼與封裝。標註影像經過 JPEG 編碼後，再轉換為 Base64 字串格式以便透過 JSON 傳輸。系統將偵測到的物體列表、標註影像、處理時間等資訊整合為一個 Python 字典，由 FastMCP 框架自動序列化為 JSON 格式，透過標準輸出回傳給 Claude Desktop。

最後，Claude Desktop 接收並解析 JSON 回應，將 Base64 編碼的影像解碼並顯示於使用者介面，同時以結構化的方式呈現偵測到的物體資訊。整個流程從使用者發起請求到看到結果，在 GPU 加速與網路狀況良好的情況下，通常可在 1 至 2 秒內完成。

## 2.6.4 系統特點與優勢

本系統具備多項技術特點與優勢。首先，採用 MCP 標準化協議簡化了系統整合的複雜度，透過 stdio 通訊避免了傳統 HTTP API 的網路配置與認證問題，降低了開發與部署的門檻。其次，系統設計強調模組化與可擴充性，各組件之間透過明確定義的介面進行通訊，未來可輕易替換或升級特定模組，例如更換為更新版本的 YOLO 模型或不同的攝像頭設備。

在效能方面，系統充分利用 GPU 加速深度學習推論過程，自動偵測並使用可用的 CUDA 設備，相較於純 CPU 運算可提升約五倍的處理速度。Kalman Filter 追蹤演算法的引入有效改善了即時偵測系統中常見的檢測框閃爍問題，透過預測與平滑機制使物體追蹤更加穩定流暢。此外，系統提供了豐富的參數調整選項，使用者可根據不同的應用場景在精確度、速度與穩定性之間取得最佳平衡。

在可靠性與診斷方面，系統內建了健康檢查工具（check_stream_health），能夠快速診斷網路連線、攝像頭狀態與影像讀取等常見問題，協助使用者排除故障。系統亦支援多種輸入來源，除了即時串流外，也能處理本地儲存的靜態圖片，提供了靈活的應用方式。

總體而言，本系統整合了現代深度學習技術、標準化通訊協議與嵌入式硬體，建構出一個高效、穩定且易於使用的智慧物體偵測平台，適用於即時監控、物體計數、異常偵測等多種實際應用場景。

---

## 附錄：系統架構圖說明

### 圖 X-1：系統三層式架構

```
┌─────────────────────────────────────────────────────────────────┐
│                    使用者介面層 (User Interface Layer)            │
│                                                                   │
│                      Claude Desktop (AI 助理)                     │
│                    • 自然語言指令解析                              │
│                    • JSON-RPC 請求生成                            │
│                    • 結果視覺化呈現                                │
└────────────────────────┬──────────────────────────────────────────┘
                         │ stdio (JSON-RPC 2.0)
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│                  協議通訊層 (Protocol Layer)                      │
│                                                                   │
│                 MCP Server (mcpclient.py)                         │
│              ┌─────────────────────────────────┐                 │
│              │  FastMCP 框架                    │                 │
│              │  • @mcp.tool() 裝飾器           │                 │
│              │  • 參數驗證與路由                │                 │
│              │  • JSON 序列化                   │                 │
│              └─────────────────────────────────┘                 │
│              ┌─────────────────────────────────┐                 │
│              │  業務邏輯模組                    │                 │
│              │  • YOLOv8 推論引擎              │                 │
│              │  • Kalman Filter 追蹤          │                 │
│              │  • OpenCV 影像處理              │                 │
│              └─────────────────────────────────┘                 │
└────────────────────────┬──────────────────────────────────────────┘
                         │ HTTP (MJPEG Stream)
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│                  硬體感知層 (Hardware Layer)                      │
│                                                                   │
│                   ESP32-CAM (視訊擷取設備)                        │
│                  • OV2640 攝像頭 (640×480)                       │
│                  • WiFi 網路串流                                  │
│                  • MJPEG 格式編碼                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 圖 X-2：系統資料流程時序圖

```
使用者          Claude Desktop      MCP Server        YOLOv8          ESP32-CAM
  │                  │                  │                │                │
  │ 1. 輸入指令      │                  │                │                │
  ├─────────────────→│                  │                │                │
  │                  │ 2. JSON-RPC 請求 │                │                │
  │                  ├─────────────────→│                │                │
  │                  │                  │ 3. 建立連線     │                │
  │                  │                  ├───────────────────────────────→│
  │                  │                  │ 4. MJPEG 串流   │                │
  │                  │                  │←───────────────────────────────┤
  │                  │                  │ 5. 解碼影像     │                │
  │                  │                  │ 6. 執行推論     │                │
  │                  │                  ├───────────────→│                │
  │                  │                  │ 7. 檢測結果     │                │
  │                  │                  │←───────────────┤                │
  │                  │                  │ 8. Kalman 追蹤 │                │
  │                  │                  │ 9. 繪製標註     │                │
  │                  │ 10. JSON 回應    │                │                │
  │                  │←─────────────────┤                │                │
  │ 11. 顯示結果     │                  │                │                │
  │←─────────────────┤                  │                │                │
  │                  │                  │                │                │
```

### 表 X-1：系統關鍵組件功能對照表

| 組件名稱 | 技術實作 | 主要功能 | 效能指標 |
|---------|---------|---------|---------|
| Claude Desktop | Anthropic AI | 使用者介面、自然語言處理 | 即時回應 |
| MCP 協議層 | FastMCP + JSON-RPC 2.0 | 程序間通訊、工具路由 | <10ms 延遲 |
| YOLOv8 模型 | Ultralytics YOLOv8 | 物體偵測、分類 | 150ms (GPU) / 800ms (CPU) |
| Kalman Filter | FilterPy 庫 | 物體追蹤、平滑 | ~100ms/幀 |
| OpenCV | cv2 4.x | 影像解碼、編碼、繪圖 | ~200ms/幀 |
| ESP32-CAM | OV2640 + ESP32 | 視訊擷取、網路串流 | 30 FPS @ 640×480 |

### 表 X-2：工具函數參數配置表

| 工具名稱 | 主要參數 | 預設值 | 調整建議 |
|---------|---------|--------|---------|
| detect_esp32_stream | imgsz | 416 | 速度優先: 320; 精度優先: 640 |
| | conf | 0.25 | 精確度優先: 0.5; 召回率優先: 0.15 |
| | frame_skip | 1 | 節能模式: 15-30 |
| | use_kalman | True | 穩定性需求高時啟用 |
| detect_stream_frame_simple | imgsz | 416 | 同上 |
| | conf | 0.3 | 平衡設定 |
| check_stream_health | - | - | 診斷用，無調整參數 |
| detect_image | imgsz | 640 | 靜態圖片建議使用較大值 |

---

**文檔版本**: v0 (Ultimate Structure Introduction)  
**最後更新**: 2025-11-06  
**用途**: 研究論文第二章系統架構說明  
**作者**: YOLOv8 MCP Server Team
