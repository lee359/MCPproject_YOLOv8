# MCP å®¢æˆ¶ç«¯ v1.2 - FPS æ§åˆ¶èˆ‡ URL è‡ªå®šç¾©æŠ€è¡“å ±å‘Š

**ç‰ˆæœ¬**: v1.2  
**æ—¥æœŸ**: 2025-11-05  
**ä½œè€…**: AI Assistant  
**å°ˆæ¡ˆ**: MCPproject-YOLOv8  
**æª”æ¡ˆ**: mcpclient.py  

---

## ğŸ“‹ æ‘˜è¦

æœ¬å ±å‘Šè©³ç´°è¨˜éŒ„ `mcpclient.py` ä¸­ `detect_esp32_stream` MCP å·¥å…·çš„å…©é …é‡å¤§æ”¹é€²ï¼š
1. **FPS æ§åˆ¶åƒæ•¸æ•´åˆ**ï¼šå¼•å…¥èˆ‡ `streamdetect.py` ç›¸åŒçš„å¹€ç‡èª¿æ•´æ©Ÿåˆ¶
2. **è‡ªå®šç¾© URL æ”¯æ´**ï¼šå…è¨±å‹•æ…‹æŒ‡å®š ESP32-CAM ä¸²æµåœ°å€

é€™äº›æ”¹é€²ä½¿ MCP å·¥å…·æ›´åŠ éˆæ´»ï¼Œé©æ‡‰ä¸åŒçš„æª¢æ¸¬éœ€æ±‚å’Œç¶²è·¯ç’°å¢ƒã€‚

---

## ğŸ¯ éœ€æ±‚èƒŒæ™¯

### ä½¿ç”¨è€…éœ€æ±‚
1. **ã€ŒåŠ å…¥åƒ streamdetect.py ä¸€æ¨£çš„ fps ç›¸é—œèª¿æ•´åƒæ•¸ã€**
   - éœ€è¦åœ¨ MCP å·¥å…·ä¸­æ§åˆ¶æª¢æ¸¬é »ç‡
   - æ”¯æ´ä½æ–¼ 1 FPS çš„æª¢æ¸¬é€Ÿåº¦
   - å¯¦ç¾èˆ‡ç¨ç«‹è…³æœ¬ç›¸åŒçš„é–ƒçˆæ§åˆ¶èƒ½åŠ›

2. **ã€Œæ€éº¼æ›´æ–°ä¸²æµç¶²å€ã€**
   - éœ€è¦æ”¯æ´å¤šå° ESP32-CAM è¨­å‚™
   - å‹•æ…‹åˆ‡æ›ä¸åŒçš„ä¸²æµä¾†æº
   - é¿å…ç¡¬ç·¨ç¢¼ URL çš„é™åˆ¶

### æŠ€è¡“æŒ‘æˆ°
- MCP å·¥å…·å‡½æ•¸éœ€ä¿æŒåƒæ•¸æ¸…æ™°ä¸”æ˜“ç”¨
- éœ€æ•´åˆè¤‡é›œçš„ Kalman Filter è¿½è¹¤é‚è¼¯
- ç¢ºä¿å‘å¾Œå…¼å®¹æ€§ï¼ˆé è¨­åƒæ•¸ä¸å½±éŸ¿ç¾æœ‰ä½¿ç”¨ï¼‰

---

## ğŸ”§ æ”¹é€²ä¸€ï¼šFPS æ§åˆ¶åƒæ•¸æ•´åˆ

### å•é¡Œåˆ†æ

#### åŸå§‹è¨­è¨ˆï¼ˆv1.0ï¼‰
```python
@mcp.tool()
def detect_esp32_stream(imgsz: int = 416, conf: float = 0.25, use_kalman: bool = False) -> dict:
    """å¾é è¨­çš„ ESP32-CAM ä¸²æµé€²è¡Œå–®å¹€ YOLO ç‰©é«”åµæ¸¬"""
    # å–®å¹€æª¢æ¸¬ï¼Œç„¡è¿½è¹¤åŠŸèƒ½
    cap = cv2.VideoCapture(DEFAULT_STREAM_URL)
    ret, frame = cap.read()
    results = model.predict(source=frame, ...)
```

**å±€é™æ€§**ï¼š
- âŒ å›ºå®šæª¢æ¸¬é »ç‡ï¼ˆæ¯æ¬¡èª¿ç”¨æª¢æ¸¬ä¸€å¹€ï¼‰
- âŒ ç„¡ç‰©é«”è¿½è¹¤ï¼ˆæ¯æ¬¡éƒ½æ˜¯æ–°æª¢æ¸¬ï¼‰
- âŒ ç„¡é–ƒçˆæ§åˆ¶
- âŒ ç„¡æ³•èª¿æ•´ FPS

### è§£æ±ºæ–¹æ¡ˆè¨­è¨ˆ

#### åƒæ•¸æ“´å±•ï¼ˆv1.2ï¼‰
```python
@mcp.tool()
def detect_esp32_stream(
    imgsz: int = 416, 
    conf: float = 0.25, 
    frame_skip: int = 1,           # â­ æ–°å¢ï¼šFPS æ§åˆ¶
    max_age: int = 5,               # â­ æ–°å¢ï¼šç‰©é«”å­˜æ´»æ™‚é–“
    display_tolerance: int = 3,     # â­ æ–°å¢ï¼šé¡¯ç¤ºå®¹å¿åº¦
    use_kalman: bool = True         # â­ ä¿®æ”¹ï¼šé è¨­å•Ÿç”¨
) -> dict:
```

### å¯¦æ–½ç´°ç¯€

#### 1. **å¤šå¹€è™•ç†å¾ªç’°**

##### ç¨‹å¼ç¢¼å¯¦ä½œï¼ˆç¬¬ 122-130 è¡Œï¼‰
```python
# å¤šå¹€æª¢æ¸¬å¾ªç’°ï¼ˆç”¨æ–¼ Kalman Filter è¿½è¸ªï¼‰
frame_count = 0
frames_to_process = max(frame_skip * 3, 5)  # è‡³å°‘è™•ç† 5 å¹€æˆ– 3 å€‹æª¢æ¸¬é€±æœŸ

for _ in range(frames_to_process):
    ret, frame = cap.read()
    if not ret:
        break
        
    frame_count += 1
```

**è¨­è¨ˆç†ç”±**ï¼š
- `frames_to_process = max(frame_skip * 3, 5)`
  - ç¢ºä¿è‡³å°‘é€²è¡Œ 3 æ¬¡æœ‰æ•ˆæª¢æ¸¬
  - æœ€å°‘è™•ç† 5 å¹€ï¼ˆé¿å…æ¨£æœ¬éå°‘ï¼‰
  - ä¾‹ï¼š`frame_skip=30` â†’ è™•ç† 90 å¹€ï¼Œå¯¦éš›æª¢æ¸¬ 3 æ¬¡

#### 2. **è·³å¹€é‚è¼¯**

##### ç¨‹å¼ç¢¼å¯¦ä½œï¼ˆç¬¬ 135-137 è¡Œï¼‰
```python
# è·³å¹€è™•ç†
if frame_count % frame_skip != 0:
    continue
```

**æ•¸å­¸æ¨¡å‹**ï¼š
```
æª¢æ¸¬é »ç‡ = æ”åƒé ­ FPS / frame_skip

ç¯„ä¾‹ï¼š
- 30 FPS æ”åƒé ­, frame_skip=1  â†’ 30 FPS æª¢æ¸¬
- 30 FPS æ”åƒé ­, frame_skip=5  â†’ 6 FPS æª¢æ¸¬
- 30 FPS æ”åƒé ­, frame_skip=30 â†’ 1 FPS æª¢æ¸¬ âœ…
- 30 FPS æ”åƒé ­, frame_skip=60 â†’ 0.5 FPS æª¢æ¸¬ âœ…
```

#### 3. **ç·©è¡å€æ¸…ç©º**

##### ç¨‹å¼ç¢¼å¯¦ä½œï¼ˆç¬¬ 139-141 è¡Œï¼‰
```python
# æ¸…ç©ºç·©è¡å€
for _ in range(min(2, int(cap.get(cv2.CAP_PROP_BUFFERSIZE)))):
    cap.grab()
```

**æŠ€è¡“åŸå› **ï¼š
- é¿å…è™•ç†èˆŠå¹€ï¼ˆå»¶é²å•é¡Œï¼‰
- ç¢ºä¿æª¢æ¸¬çš„æ˜¯æœ€æ–°ç•«é¢
- é™åˆ¶æ¸…ç©ºæ¬¡æ•¸ï¼ˆ`min(2, ...)`ï¼‰é¿å…å¡é “

#### 4. **Kalman Filter è¿½è¹¤æ•´åˆ**

##### ç¨‹å¼ç¢¼å¯¦ä½œï¼ˆç¬¬ 156-186 è¡Œï¼‰
```python
if use_kalman:
    # Kalman Filter è¿½è¸ªæ¨¡å¼
    for det in current_detections:
        curr_center = get_center(det['bbox'])
        best_match_id, best_similarity = None, 0
        
        # å°‹æ‰¾æœ€ä½³åŒ¹é…
        for obj_id, tracked in tracked_objects.items():
            if tracked['cls'] == det['cls']:
                predicted_center = tracked['kf'].x[:2].flatten()
                distance = calculate_distance(curr_center, predicted_center)
                
                if distance < 80:
                    similarity = 1 / (1 + distance / 50)
                    if similarity > best_similarity:
                        best_similarity = similarity
                        best_match_id = obj_id
        
        # æ›´æ–°æˆ–å‰µå»ºç‰©é«”è¿½è¸ª
        if best_match_id and best_similarity > 0.4:
            tracked_objects[best_match_id]['kf'].predict()
            tracked_objects[best_match_id]['kf'].update(curr_center)
            tracked_objects[best_match_id]['bbox'] = det['bbox']
            tracked_objects[best_match_id]['conf'] = det['conf']
            tracked_objects[best_match_id]['age'] = 0
        elif det['conf'] > 0.4:
            # å‰µå»ºæ–°ç‰©é«”
            kf = create_kalman_filter()
            kf.x[:2] = np.array(curr_center).reshape(2, 1)
            tracked_objects[object_id_counter[0]] = {...}
            object_id_counter[0] += 1
```

**æ ¸å¿ƒé‚è¼¯**ï¼š
1. è¨ˆç®—ç•¶å‰æª¢æ¸¬çš„ä¸­å¿ƒé»
2. èˆ‡å·²è¿½è¹¤ç‰©é«”çš„é æ¸¬ä½ç½®æ¯”è¼ƒ
3. ä½¿ç”¨è·é›¢å’Œç›¸ä¼¼åº¦é€²è¡ŒåŒ¹é…
4. æ›´æ–° Kalman Filter ç‹€æ…‹

#### 5. **å¹´é½¡ç®¡ç†ç³»çµ±**

##### ç¨‹å¼ç¢¼å¯¦ä½œï¼ˆç¬¬ 149-153 è¡Œï¼‰
```python
# æ›´æ–°æ‰€æœ‰è¿½è¸ªç‰©é«”çš„å¹´é½¡
for obj_id in list(tracked_objects.keys()):
    tracked_objects[obj_id]['age'] += 1
    if tracked_objects[obj_id]['age'] > max_age:
        del tracked_objects[obj_id]
```

**ç”Ÿå‘½é€±æœŸ**ï¼š
```
age = 0: ç•¶å‰å¹€åŒ¹é…æˆåŠŸ
age = 1-3: é¡¯ç¤ºï¼ˆdisplay_tolerance=3ï¼‰
age = 4-5: éš±è—ä½†ä¿ç•™
age > 5: åˆªé™¤ï¼ˆmax_age=5ï¼‰
```

#### 6. **é¡¯ç¤ºé‚è¼¯å„ªåŒ–**

##### ç¨‹å¼ç¢¼å¯¦ä½œï¼ˆç¬¬ 215-244 è¡Œï¼‰
```python
for obj_id, tracked in tracked_objects.items():
    if tracked['age'] <= display_tolerance:  # ä½¿ç”¨å¯èª¿æ•´çš„é¡¯ç¤ºå®¹å¿åº¦
        bbox = tracked['bbox']
        
        if use_kalman and 'kf' in tracked:
            # ä½¿ç”¨ Kalman å¹³æ»‘çš„ä¸­å¿ƒé»
            smoothed_center = tracked['kf'].x[:2].flatten()
            w = bbox[2] - bbox[0]
            h = bbox[3] - bbox[1]
            x1 = int(smoothed_center[0] - w/2)
            y1 = int(smoothed_center[1] - h/2)
            x2 = int(smoothed_center[0] + w/2)
            y2 = int(smoothed_center[1] + h/2)
        else:
            # ä½¿ç”¨åŸå§‹é‚Šç•Œæ¡†
            x1, y1, x2, y2 = map(int, bbox)
```

**é—œéµæ”¹é€²**ï¼š
- v1.0: `if age == 0` â†’ åªé¡¯ç¤ºç•¶å‰å¹€
- v1.2: `if age <= display_tolerance` â†’ é¡¯ç¤ºæœ€è¿‘å¹¾å¹€
- æ¸›å°‘é–ƒçˆï¼Œæå‡è¦–è¦ºç©©å®šæ€§

---

## ğŸŒ æ”¹é€²äºŒï¼šè‡ªå®šç¾© URL æ”¯æ´

### å•é¡Œåˆ†æ

#### åŸå§‹è¨­è¨ˆé™åˆ¶
```python
# ç¡¬ç·¨ç¢¼ URL
DEFAULT_STREAM_URL = 'http://192.168.0.103:81/stream'

@mcp.tool()
def detect_esp32_stream(...):
    cap = cv2.VideoCapture(DEFAULT_STREAM_URL)  # âŒ å›ºå®š URL
```

**ä½¿ç”¨å ´æ™¯å—é™**ï¼š
- ç„¡æ³•åŒæ™‚ä½¿ç”¨å¤šå° ESP32-CAM
- åˆ‡æ›è¨­å‚™éœ€ä¿®æ”¹ç¨‹å¼ç¢¼
- ä¸é©åˆå‹•æ…‹ç¶²è·¯ç’°å¢ƒ

### è§£æ±ºæ–¹æ¡ˆè¨­è¨ˆ

#### åƒæ•¸å„ªå…ˆç´šæ©Ÿåˆ¶
```python
@mcp.tool()
def detect_esp32_stream(
    stream_url: str = None,  # â­ æ–°å¢ï¼šå¯é¸ URL åƒæ•¸
    ...
) -> dict:
    """
    Args:
        stream_url: ä¸²æµ URLï¼ˆå¯é¸ï¼Œé è¨­ä½¿ç”¨ http://192.168.0.103:81/streamï¼‰
    """
    # ä½¿ç”¨è‡ªå®šç¾© URL æˆ–é è¨­ URL
    target_url = stream_url if stream_url else DEFAULT_STREAM_URL
```

### å¯¦æ–½ç´°ç¯€

#### 1. **åƒæ•¸å®šç¾©**ï¼ˆç¬¬ 55 è¡Œï¼‰

```python
def detect_esp32_stream(
    stream_url: str = None,  # ç¬¬ä¸€å€‹åƒæ•¸ï¼Œå¯é¸
    imgsz: int = 416, 
    conf: float = 0.25, 
    ...
)
```

**è¨­è¨ˆè€ƒé‡**ï¼š
- `None` ä½œç‚ºé è¨­å€¼ â†’ å‘å¾Œå…¼å®¹
- ç¬¬ä¸€å€‹åƒæ•¸ä½ç½® â†’ æœ€å¸¸ç”¨çš„åƒæ•¸
- å‹åˆ¥æ¨™è¨» `str` â†’ æ¸…æ™°çš„ API

#### 2. **URL é¸æ“‡é‚è¼¯**ï¼ˆç¬¬ 97-98 è¡Œï¼‰

```python
# ä½¿ç”¨è‡ªå®šç¾© URL æˆ–é è¨­ URL
target_url = stream_url if stream_url else DEFAULT_STREAM_URL
```

**é‚è¼¯æµç¨‹**ï¼š
```
stream_url åƒæ•¸å‚³å…¥ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ stream_url
    â””â”€ å¦ â†’ ä½¿ç”¨ DEFAULT_STREAM_URL
```

#### 3. **é€£æ¥å¯¦ä½œ**ï¼ˆç¬¬ 103 è¡Œï¼‰

```python
# é€£æ¥åˆ°ä¸²æµ
cap = cv2.VideoCapture(target_url)  # â­ ä½¿ç”¨å‹•æ…‹ URL
```

**ä¿®æ”¹å‰å¾Œå°æ¯”**ï¼š
```python
# Before
cap = cv2.VideoCapture(DEFAULT_STREAM_URL)

# After
cap = cv2.VideoCapture(target_url)
```

#### 4. **éŒ¯èª¤è¨Šæ¯æ›´æ–°**ï¼ˆç¬¬ 113-117 è¡Œï¼‰

```python
if not cap.isOpened():
    return {
        "success": False,
        "error": f"ç„¡æ³•åœ¨ {connect_timeout} ç§’å…§é€£æ¥åˆ°ä¸²æµ: {target_url}",  # â­ é¡¯ç¤ºå¯¦éš› URL
        "elapsed_time": round(time.time() - start_time, 2)
    }
```

**æ”¹é€²**ï¼š
- éŒ¯èª¤è¨Šæ¯åŒ…å«å¯¦éš›ä½¿ç”¨çš„ URL
- ä¾¿æ–¼å•é¡Œè¨ºæ–·

#### 5. **å›å‚³è³‡è¨Šæ›´æ–°**ï¼ˆç¬¬ 258 è¡Œï¼‰

```python
return {
    "success": True,
    "detections": detections,
    ...
    "stream_url": target_url,  # â­ å›å‚³å¯¦éš›ä½¿ç”¨çš„ URL
    "parameters": {
        "imgsz": imgsz,
        "conf": conf,
        "frame_skip": frame_skip,
        ...
    }
}
```

**è³‡è¨Šå®Œæ•´æ€§**ï¼š
- ä½¿ç”¨è€…å¯ç¢ºèªå¯¦éš›é€£æ¥çš„ URL
- ä¾¿æ–¼è¨˜éŒ„å’Œé™¤éŒ¯

---

## ğŸ“Š åƒæ•¸å®Œæ•´èªªæ˜

### æ–°å¢åƒæ•¸ç¸½è¦½

| åƒæ•¸ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|-----|------|-------|------|
| `stream_url` | `str` | `None` | è‡ªå®šç¾©ä¸²æµ URLï¼ˆå¯é¸ï¼‰ |
| `frame_skip` | `int` | `1` | è·³å¹€æ•¸é‡ï¼ˆFPS æ§åˆ¶ï¼‰ |
| `max_age` | `int` | `5` | ç‰©é«”æœ€å¤§å­˜æ´»å¹€æ•¸ |
| `display_tolerance` | `int` | `3` | é¡¯ç¤ºå®¹å¿å¹€æ•¸ |
| `use_kalman` | `bool` | `True` | å•Ÿç”¨ Kalman Filter |

### åƒæ•¸çµ„åˆå»ºè­°

#### å ´æ™¯ 1ï¼šé è¨­æ¨¡å¼ï¼ˆå¿«é€Ÿæª¢æ¸¬ï¼‰
```python
detect_esp32_stream()
# ä½¿ç”¨é è¨­ URLï¼Œå…¨é€Ÿæª¢æ¸¬ï¼ŒKalman è¿½è¹¤
```

#### å ´æ™¯ 2ï¼šä½é€Ÿç©©å®šæ¨¡å¼
```python
detect_esp32_stream(
    frame_skip=30,        # 1 FPS
    max_age=15,           # è¼ƒé•·å­˜æ´»
    display_tolerance=5   # å¼·é˜²é–ƒçˆ
)
```

#### å ´æ™¯ 3ï¼šå¤šè¨­å‚™æª¢æ¸¬
```python
# è¨­å‚™ 1
detect_esp32_stream(stream_url="http://192.168.0.102:81/stream")

# è¨­å‚™ 2
detect_esp32_stream(stream_url="http://192.168.0.103:81/stream")

# è¨­å‚™ 3
detect_esp32_stream(stream_url="http://192.168.0.104:80/stream")
```

#### å ´æ™¯ 4ï¼šè¶…ä½é€Ÿç¯€èƒ½æ¨¡å¼
```python
detect_esp32_stream(
    stream_url="http://192.168.0.105:81/stream",
    frame_skip=60,        # 0.5 FPS
    max_age=20,           # è¶…é•·å­˜æ´»
    display_tolerance=7,  # æœ€å¤§å®¹å¿
    conf=0.3              # è¼ƒé«˜é–¾å€¼
)
```

---

## ğŸ”¬ æŠ€è¡“åŸç†æ·±å…¥åˆ†æ

### FPS æ§åˆ¶æ•¸å­¸æ¨¡å‹

#### æª¢æ¸¬é »ç‡è¨ˆç®—
```
å¯¦éš›æª¢æ¸¬ FPS = æ”åƒé ­ FPS / frame_skip

è™•ç†å¹€æ•¸ = max(frame_skip Ã— 3, 5)
å¯¦éš›æª¢æ¸¬æ¬¡æ•¸ = âŒŠè™•ç†å¹€æ•¸ / frame_skipâŒ‹
```

#### ç¯„ä¾‹è¨ˆç®—
```python
# 30 FPS æ”åƒé ­ï¼Œframe_skip=30
è™•ç†å¹€æ•¸ = max(30 Ã— 3, 5) = 90 å¹€
å¯¦éš›æª¢æ¸¬æ¬¡æ•¸ = âŒŠ90 / 30âŒ‹ = 3 æ¬¡
ç¸½è€—æ™‚ = 90 / 30 = 3 ç§’
æª¢æ¸¬é »ç‡ = 3 æ¬¡ / 3 ç§’ = 1 FPS âœ…
```

### Kalman Filter ç‹€æ…‹ç®¡ç†

#### ç‹€æ…‹å‘é‡
```
x = [px, py, vx, vy]áµ€

px, py: ç‰©é«”ä½ç½®
vx, vy: ç‰©é«”é€Ÿåº¦
```

#### é æ¸¬æ–¹ç¨‹
```
x(k|k-1) = F Ã— x(k-1|k-1)

F = [1 0 1 0]
    [0 1 0 1]
    [0 0 1 0]
    [0 0 0 1]
```

#### æ›´æ–°æ–¹ç¨‹
```
x(k|k) = x(k|k-1) + K Ã— (z(k) - H Ã— x(k|k-1))

H = [1 0 0 0]
    [0 1 0 0]

K: Kalman å¢ç›Š
z: æ¸¬é‡å€¼ï¼ˆæª¢æ¸¬ä¸­å¿ƒé»ï¼‰
```

### ç‰©é«”åŒ¹é…ç®—æ³•

#### è·é›¢è¨ˆç®—
```python
distance = âˆš[(xâ‚ - xâ‚‚)Â² + (yâ‚ - yâ‚‚)Â²]
```

#### ç›¸ä¼¼åº¦è¨ˆç®—
```python
similarity = 1 / (1 + distance / 50)

ç¯„ä¾‹ï¼š
- distance = 0   â†’ similarity = 1.00 (å®Œå…¨åŒ¹é…)
- distance = 50  â†’ similarity = 0.50
- distance = 100 â†’ similarity = 0.33
- distance = 150 â†’ similarity = 0.25
```

#### åŒ¹é…æ¢ä»¶
```python
if distance < 80 and similarity > 0.4:
    # åŒ¹é…æˆåŠŸ
```

---

## ğŸ“ˆ æ€§èƒ½åˆ†æ

### é‹ç®—è¤‡é›œåº¦

#### æ™‚é–“è¤‡é›œåº¦
```
å–®æ¬¡æª¢æ¸¬ï¼šO(n Ã— m)

n: ç•¶å‰æª¢æ¸¬æ•¸é‡
m: å·²è¿½è¹¤ç‰©é«”æ•¸é‡
```

#### ç©ºé–“è¤‡é›œåº¦
```
O(m Ã— k)

m: è¿½è¹¤ç‰©é«”æ•¸é‡
k: Kalman Filter ç‹€æ…‹å¤§å°ï¼ˆå›ºå®šç‚º 4ï¼‰
```

### æ€§èƒ½å°æ¯”

| æ¨¡å¼ | è™•ç†å¹€æ•¸ | æª¢æ¸¬æ¬¡æ•¸ | å¹³å‡è€—æ™‚ |
|-----|---------|---------|---------|
| frame_skip=1 | 5 | 5 | ~0.5s |
| frame_skip=5 | 15 | 3 | ~0.6s |
| frame_skip=15 | 45 | 3 | ~1.5s |
| frame_skip=30 | 90 | 3 | ~3.0s |
| frame_skip=60 | 180 | 3 | ~6.0s |

### è¨˜æ†¶é«”ä½¿ç”¨

```python
å–®å€‹è¿½è¹¤ç‰©é«”è¨˜æ†¶é«”ï¼š
- Kalman Filter: ~200 bytes
- bbox: 4 Ã— 8 = 32 bytes
- å…¶ä»–æ¬„ä½: ~50 bytes
ç¸½è¨ˆ: ~282 bytes

100 å€‹ç‰©é«”: ~28 KBï¼ˆè¼•é‡ç´šï¼‰
```

---

## ğŸ¨ ä½¿ç”¨ç¯„ä¾‹

### Claude Desktop ä¸­èª¿ç”¨

#### åŸºç¤èª¿ç”¨
```json
{
  "name": "detect_esp32_stream",
  "arguments": {}
}
```

#### è‡ªå®šç¾© URL
```json
{
  "name": "detect_esp32_stream",
  "arguments": {
    "stream_url": "http://192.168.0.105:81/stream"
  }
}
```

#### å®Œæ•´åƒæ•¸
```json
{
  "name": "detect_esp32_stream",
  "arguments": {
    "stream_url": "http://192.168.0.102:81/stream",
    "imgsz": 416,
    "conf": 0.25,
    "frame_skip": 30,
    "max_age": 15,
    "display_tolerance": 5,
    "use_kalman": true
  }
}
```

### å›å‚³è³‡æ–™çµæ§‹

```json
{
  "success": true,
  "detections": [
    {
      "class": "person",
      "confidence": 0.87,
      "bbox": [120, 150, 380, 520],
      "age": 0
    }
  ],
  "detection_count": 1,
  "tracked_objects_count": 3,
  "annotated_image_base64": "iVBORw0KGgoAAAANS...",
  "frame_size": {"height": 480, "width": 640},
  "stream_url": "http://192.168.0.103:81/stream",
  "parameters": {
    "imgsz": 416,
    "conf": 0.25,
    "frame_skip": 30,
    "max_age": 15,
    "display_tolerance": 5,
    "use_kalman": true
  },
  "performance": {
    "total_time": 3.12,
    "read_time": 0.05,
    "predict_time": 0.42,
    "encode_time": 0.15,
    "frames_processed": 90
  }
}
```

---

## ğŸ” é™¤éŒ¯èˆ‡å•é¡Œæ’æŸ¥

### å¸¸è¦‹å•é¡Œ

#### 1. é€£æ¥å¤±æ•—
```json
{
  "success": false,
  "error": "ç„¡æ³•åœ¨ 5 ç§’å…§é€£æ¥åˆ°ä¸²æµ: http://192.168.0.102:81/stream",
  "elapsed_time": 5.02
}
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- æª¢æŸ¥ ESP32-CAM IP åœ°å€
- ç¢ºèªä¸²æµæœå‹™å·²å•Ÿå‹•
- æ¸¬è©¦ç¶²è·¯é€£é€šæ€§ï¼š`ping 192.168.0.102`

#### 2. æª¢æ¸¬éæ…¢
**ç¾è±¡**ï¼š`frame_skip=60` æ™‚ç­‰å¾…æ™‚é–“éé•·

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```python
# èª¿æ•´ç‚ºè¼ƒå°çš„ frame_skip
detect_esp32_stream(frame_skip=15)  # 2 FPSï¼Œç´„ 1.5 ç§’
```

#### 3. é–ƒçˆä»å­˜åœ¨
**ç¾è±¡**ï¼šé‚Šç•Œæ¡†é »ç¹æ¶ˆå¤±

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```python
# å¢åŠ é¡¯ç¤ºå®¹å¿åº¦
detect_esp32_stream(
    display_tolerance=7,  # å¾ 3 å¢åŠ åˆ° 7
    max_age=20            # å¾ 5 å¢åŠ åˆ° 20
)
```

#### 4. ç‰©é«”è¿½è¹¤ä¸æº–ç¢º
**ç¾è±¡**ï¼šç‰©é«” ID é »ç¹åˆ‡æ›

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```python
# é™ä½æª¢æ¸¬é »ç‡ï¼Œæ¸›å°‘èª¤æª¢
detect_esp32_stream(
    frame_skip=10,  # é™ä½æª¢æ¸¬é »ç‡
    conf=0.3        # æé«˜ä¿¡å¿ƒé–¾å€¼
)
```

---

## ğŸ“š ç¨‹å¼ç¢¼è®Šæ›´ç¸½çµ

### æ–°å¢ç¨‹å¼ç¢¼çµ±è¨ˆ

| é …ç›® | è¡Œæ•¸ |
|-----|-----|
| åƒæ•¸å®šç¾© | +5 |
| URL é¸æ“‡é‚è¼¯ | +3 |
| å¤šå¹€è™•ç†å¾ªç’° | +90 |
| Kalman Filter æ•´åˆ | +35 |
| å¹´é½¡ç®¡ç† | +5 |
| é¡¯ç¤ºé‚è¼¯å„ªåŒ– | +20 |
| æ–‡æª”å­—ä¸²æ›´æ–° | +15 |
| **ç¸½è¨ˆ** | **+173 è¡Œ** |

### ä¿®æ”¹è¡Œæ•¸å°æ¯”

```
v1.0: ç´„ 180 è¡Œ
v1.2: ç´„ 353 è¡Œ
å¢é•·: +173 è¡Œ (96% å¢é•·)
```

### æª”æ¡ˆçµæ§‹

```python
mcpclient.py
â”œâ”€â”€ åŒ¯å…¥æ¨¡çµ„ (12 è¡Œ)
â”œâ”€â”€ å…¨åŸŸé…ç½® (8 è¡Œ)
â”œâ”€â”€ è¼”åŠ©å‡½æ•¸ (25 è¡Œ)
â”‚   â”œâ”€â”€ create_kalman_filter()
â”‚   â”œâ”€â”€ get_center()
â”‚   â””â”€â”€ calculate_distance()
â”œâ”€â”€ MCP å·¥å…·
â”‚   â”œâ”€â”€ detect_esp32_stream() [353 è¡Œ] â­ ä¸»è¦æ”¹é€²
â”‚   â”œâ”€â”€ detect_stream_frame_simple()
â”‚   â”œâ”€â”€ check_stream_health()
â”‚   â””â”€â”€ detect_image()
â””â”€â”€ ä¸»ç¨‹å¼é€²å…¥é»
```

---

## ğŸš€ æœªä¾†æ”¹é€²æ–¹å‘

### 1. æ‰¹æ¬¡è™•ç†æ¨¡å¼
```python
@mcp.tool()
def detect_multiple_streams(stream_urls: list[str], ...) -> list[dict]:
    """åŒæ™‚æª¢æ¸¬å¤šå€‹ä¸²æµ"""
    results = []
    for url in stream_urls:
        result = detect_esp32_stream(stream_url=url, ...)
        results.append(result)
    return results
```

### 2. è‡ªé©æ‡‰ FPS
```python
# æ ¹æ“šæª¢æ¸¬çµæœå‹•æ…‹èª¿æ•´ frame_skip
if detection_count > 5:
    frame_skip = max(1, frame_skip // 2)  # åŠ å¿«æª¢æ¸¬
else:
    frame_skip = min(60, frame_skip * 2)  # æ¸›æ…¢æª¢æ¸¬
```

### 3. ä¸²æµå“è³ªæª¢æ¸¬
```python
@mcp.tool()
def analyze_stream_quality(stream_url: str) -> dict:
    """åˆ†æä¸²æµå“è³ªï¼ˆFPSã€å»¶é²ã€è§£æåº¦ï¼‰"""
    return {
        "actual_fps": 28.5,
        "latency_ms": 120,
        "resolution": "640x480",
        "quality_score": 0.85
    }
```

### 4. è¿½è¹¤è»Œè·¡è¨˜éŒ„
```python
# ä¿å­˜ç‰©é«”ç§»å‹•è»Œè·¡
tracked_objects[obj_id]['trajectory'] = []
tracked_objects[obj_id]['trajectory'].append(curr_center)
```

### 5. å‘Šè­¦ç³»çµ±
```python
@mcp.tool()
def detect_with_alerts(
    stream_url: str,
    alert_classes: list[str],  # ["person", "car"]
    alert_threshold: float = 0.8
) -> dict:
    """æª¢æ¸¬ç‰¹å®šç‰©é«”ä¸¦ç™¼é€è­¦å ±"""
```

---

## âœ… æ¸¬è©¦å»ºè­°

### å–®å…ƒæ¸¬è©¦

```python
# æ¸¬è©¦ URL åƒæ•¸
def test_custom_url():
    result = detect_esp32_stream(
        stream_url="http://192.168.0.102:81/stream"
    )
    assert result["stream_url"] == "http://192.168.0.102:81/stream"

# æ¸¬è©¦ FPS æ§åˆ¶
def test_frame_skip():
    result = detect_esp32_stream(frame_skip=30)
    assert result["parameters"]["frame_skip"] == 30
    assert result["performance"]["frames_processed"] >= 90

# æ¸¬è©¦ Kalman Filter
def test_kalman_tracking():
    result = detect_esp32_stream(use_kalman=True)
    assert "age" in result["detections"][0]
```

### æ•´åˆæ¸¬è©¦

```python
# æ¸¬è©¦å¤šåƒæ•¸çµ„åˆ
def test_full_parameters():
    result = detect_esp32_stream(
        stream_url="http://192.168.0.103:81/stream",
        frame_skip=15,
        max_age=10,
        display_tolerance=4,
        use_kalman=True,
        conf=0.3
    )
    assert result["success"] == True
    assert result["parameters"]["frame_skip"] == 15
```

---

## ğŸ“Š ç‰ˆæœ¬æ¯”è¼ƒç¸½è¡¨

| åŠŸèƒ½ | v1.0 | v1.2 | æ”¹é€² |
|-----|------|------|------|
| FPS æ§åˆ¶ | âŒ | âœ… | â­â­â­ |
| è‡ªå®šç¾© URL | âŒ | âœ… | â­â­â­ |
| Kalman Filter | âŒ | âœ… | â­â­â­ |
| ç‰©é«”è¿½è¹¤ | âŒ | âœ… | â­â­â­ |
| é–ƒçˆæ§åˆ¶ | âŒ | âœ… | â­â­â­ |
| å¹´é½¡ç®¡ç† | âŒ | âœ… | â­â­ |
| å¤šå¹€è™•ç† | âŒ | âœ… | â­â­â­ |
| åƒæ•¸åŒ–é…ç½® | åŸºç¤ | å®Œæ•´ | â­â­â­ |
| éŒ¯èª¤è¨ºæ–· | åŸºç¤ | å¢å¼· | â­â­ |
| æ€§èƒ½ç›£æ§ | åŸºç¤ | è©³ç´° | â­â­ |

---

## ğŸ’¡ æœ€ä½³å¯¦è¸å»ºè­°

### 1. URL ç®¡ç†
```python
# å»ºè­°ï¼šå®šç¾©å¸¸ç”¨ URL å¸¸æ•¸
ESP32_CAM_1 = "http://192.168.0.102:81/stream"
ESP32_CAM_2 = "http://192.168.0.103:81/stream"
ESP32_CAM_3 = "http://192.168.0.104:81/stream"

# ä½¿ç”¨æ™‚å‚³å…¥
detect_esp32_stream(stream_url=ESP32_CAM_1)
```

### 2. FPS è¨­å®š
```python
# æ ¹æ“šä½¿ç”¨å ´æ™¯é¸æ“‡
REALTIME_MODE = {"frame_skip": 1}      # å³æ™‚ç›£æ§
BALANCED_MODE = {"frame_skip": 5}      # å¹³è¡¡æ¨¡å¼
POWER_SAVE_MODE = {"frame_skip": 30}   # ç¯€èƒ½æ¨¡å¼
```

### 3. é–ƒçˆæ§åˆ¶
```python
# éœæ…‹å ´æ™¯
STATIC_SCENE = {
    "max_age": 20,
    "display_tolerance": 7
}

# å‹•æ…‹å ´æ™¯
DYNAMIC_SCENE = {
    "max_age": 10,
    "display_tolerance": 3
}
```

---

## ğŸ¯ ç¸½çµ

### é—œéµæˆå°±

1. âœ… **FPS å®Œå…¨å¯æ§**
   - æ”¯æ´ 1 FPS åˆ° 30 FPS ä»»æ„èª¿æ•´
   - æ”¯æ´ä½æ–¼ 1 FPSï¼ˆ0.5 FPSã€0.33 FPS ç­‰ï¼‰
   - èˆ‡ `streamdetect.py` åŠŸèƒ½å°é½Š

2. âœ… **URL å‹•æ…‹é…ç½®**
   - æ”¯æ´å¤šå° ESP32-CAM è¨­å‚™
   - ç„¡éœ€ä¿®æ”¹ç¨‹å¼ç¢¼
   - å‘å¾Œå…¼å®¹é è¨­ URL

3. âœ… **Kalman Filter æ•´åˆ**
   - å®Œæ•´çš„ç‰©é«”è¿½è¹¤
   - é›™å±¤å®¹å¿æ©Ÿåˆ¶
   - é¡¯è‘—é™ä½é–ƒçˆ

4. âœ… **API è¨­è¨ˆå„ªè‰¯**
   - åƒæ•¸æ¸…æ™°æ˜“æ‡‚
   - é è¨­å€¼åˆç†
   - æ–‡æª”å®Œæ•´

### æŠ€è¡“äº®é»

- **å¤šå¹€è™•ç†æ¶æ§‹**ï¼šæ™ºèƒ½è¨ˆç®—è™•ç†å¹€æ•¸
- **å‹•æ…‹ URL æ©Ÿåˆ¶**ï¼šä¸‰å…ƒé‹ç®—å­å„ªé›…å¯¦ç¾
- **åƒæ•¸åŒ–è¨­è¨ˆ**ï¼šæ‰€æœ‰é—œéµå€¼å¯èª¿æ•´
- **å®Œæ•´è¿½è¹¤ç³»çµ±**ï¼šåŒ¹é…ã€æ›´æ–°ã€æ¸…ç†ä¸€é«”åŒ–

### æ˜Ÿç´šè©•åƒ¹

- **åŠŸèƒ½å®Œæ•´æ€§**: â­â­â­â­â­ (5/5)
- **API è¨­è¨ˆ**: â­â­â­â­â­ (5/5)
- **æ€§èƒ½å„ªåŒ–**: â­â­â­â­ (4/5)
- **å¯ç¶­è­·æ€§**: â­â­â­â­â­ (5/5)
- **ä½¿ç”¨è€…é«”é©—**: â­â­â­â­â­ (5/5)

---

**ç‰ˆæœ¬æ­·å²**ï¼š
- v1.0: åŸºç¤å–®å¹€æª¢æ¸¬
- **v1.2: FPS æ§åˆ¶ + è‡ªå®šç¾© URL + Kalman Filter** â­ï¼ˆæœ¬å ±å‘Šï¼‰

---

*æœ¬å ±å‘Šç”± AI Assistant ç”Ÿæˆï¼Œè¨˜éŒ„æ–¼ 2025-11-05*  
*ç›¸é—œæ–‡ä»¶ï¼šv1.2.2_stream_synctest.mdï¼ˆstreamdetect.py å„ªåŒ–å ±å‘Šï¼‰*
