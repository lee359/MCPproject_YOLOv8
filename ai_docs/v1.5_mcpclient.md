# v1.5 MCP Client - detect_esp32_stream å„ªåŒ–è¨˜éŒ„

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-11-08

---

## ğŸ¯ å„ªåŒ–ç›®æ¨™

å„ªåŒ– `detect_esp32_stream` å·¥å…·ï¼Œä½¿å…¶æ›´é©åˆå³æ™‚è¿½è¸ªç ”ç©¶ï¼š
1. **å¤§å¹…é™ä½ API Token æ¶ˆè€—** - å¾ 20,000 tokens/æ¬¡ é™è‡³ ~74 tokens/æ¬¡
2. **ä¿ç•™å®Œæ•´è¿½è¸ªåŠŸèƒ½** - Kalman Filterã€å¤šç‰©é«”è¿½è¸ªã€ç¹ªè£½åŠŸèƒ½
3. **çµ±ä¸€æ•¸æ“šæ ¼å¼** - èˆ‡å…¶ä»–æª¢æ¸¬å·¥å…·ä¿æŒä¸€è‡´
4. **è‡ªå‹• CSV è¨˜éŒ„** - æ¯æ¬¡æª¢æ¸¬è‡ªå‹•è¨˜éŒ„åˆ° `detection_logs_tracked.csv`

---

## ğŸ”§ å„ªåŒ–å…§å®¹

### 1. ç§»é™¤ Base64 åœ–åƒè¼¸å‡º (æœ€é‡è¦å„ªåŒ–)

#### ä¿®æ”¹ä½ç½®
- **æ–‡ä»¶**: `mcpclient.py`
- **å‡½æ•¸**: `detect_esp32_stream()`
- **è¡Œæ•¸**: ç´„ç¬¬ 401-407 è¡Œ

#### ä¿®æ”¹å‰
```python
# å°‡åœ–åƒè½‰æ›ç‚º base64
encode_start = time.time()
_, buffer = cv2.imencode('.jpg', annotated_frame)
img_base64 = base64.b64encode(buffer).decode('utf-8')
encode_time = time.time() - encode_start

success = True
```

#### ä¿®æ”¹å¾Œ
```python
# âœ… ä¿ç•™ç¹ªè£½åŠŸèƒ½ï¼Œä½†ä¸è½‰æ›ç‚º base64ï¼ˆç¯€çœå‚³è¼¸é‡ï¼‰
# å¦‚æœéœ€è¦ä¿å­˜åœ–åƒï¼Œå¯ä»¥åœ¨é€™è£¡æ·»åŠ  cv2.imwrite() ä¿å­˜åˆ°æœ¬åœ°

success = True
```

#### æ•ˆæœ
- **æ•¸æ“šå¤§å°**: 80 KB â†’ 0 KB
- **Token æ¶ˆè€—**: 20,000 tokens â†’ 0 tokens
- **ç¯€çœ**: 99.5% â¬‡ï¸

---

### 2. æ·»åŠ è‡ªå‹• CSV è¨˜éŒ„åŠŸèƒ½

#### æ–°å¢å‡½æ•¸: `log_tracking_to_csv()`

**ä½ç½®**: `mcpclient.py` ç¬¬ 171-220 è¡Œ

```python
def log_tracking_to_csv(result_data):
    """
    å°‡è¿½è¸ªçµæœè¨˜éŒ„åˆ° CSV æª”æ¡ˆï¼ˆæ¯å€‹ç‰©é«”ä¸€è¡Œï¼‰
    
    Args:
        result_data: detect_esp32_stream çš„è¿”å›å€¼
    """
    # CSV æ¬„ä½åç¨±ï¼ˆèˆ‡å…¶ä»– CSV æ ¼å¼ä¸€è‡´ï¼‰
    fieldnames = ['timestamp', 'detection_count', 'class', 'confidence', 'bbox', 'total_time', 'yolo_inference_time']
    
    # ä½¿ç”¨èˆ‡ multi ä¸åŒçš„æª”æ¡ˆåç¨±
    csv_path = os.path.join(SCRIPT_DIR, "detection_logs_tracked.csv")
    
    # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
    file_exists = os.path.isfile(csv_path)
    
    try:
        with open(csv_path, 'a', newline='', encoding='utf-8') as csvfile:
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
            
            # å¦‚æœæª”æ¡ˆä¸å­˜åœ¨ï¼Œå¯«å…¥æ¨™é¡Œåˆ—
            if not file_exists:
                writer.writeheader()
            
            # ç²å–æ‰€æœ‰è¿½è¸ªåˆ°çš„ç‰©é«”
            detections = result_data.get('detections', [])
            
            if detections:
                # æœ‰æª¢æ¸¬åˆ°ç‰©é«”ï¼šç‚ºæ¯å€‹ç‰©é«”å¯«å…¥ä¸€è¡Œ
                for det in detections:
                    row_data = {
                        'timestamp': result_data.get('timestamp', ''),
                        'detection_count': result_data.get('detection_count', 0),
                        'class': det.get('class', ''),
                        'confidence': round(det.get('confidence', 0), 3),
                        'bbox': str([round(coord, 3) for coord in det.get('bbox', [])]),
                        'total_time': result_data.get('total_time', 0),
                        'yolo_inference_time': result_data.get('yolo_inference_time', 0)
                    }
                    writer.writerow(row_data)
            else:
                # æ²’æœ‰æª¢æ¸¬åˆ°ç‰©é«”ï¼šå¯«å…¥ä¸€è¡Œç©ºè¨˜éŒ„
                row_data = {
                    'timestamp': result_data.get('timestamp', ''),
                    'detection_count': 0,
                    'class': '',
                    'confidence': 0,
                    'bbox': '',
                    'total_time': result_data.get('total_time', 0),
                    'yolo_inference_time': result_data.get('yolo_inference_time', 0)
                }
                writer.writerow(row_data)
            
    except Exception as e:
        print(f"âŒ CSV è¨˜éŒ„å¤±æ•—: {e}", file=sys.stderr)
```

#### èª¿ç”¨ä½ç½®
åœ¨ `detect_esp32_stream()` è¿”å›å‰è‡ªå‹•èª¿ç”¨ï¼ˆç¬¬ 436 è¡Œï¼‰ï¼š

```python
result = {
    "timestamp": datetime.now().isoformat(),
    "detection_count": len(detections),
    "detections": detections,
    "total_time": round(total_time, 3),
    "yolo_inference_time": round(yolo_time, 3)
}

# âœ… è‡ªå‹•è¨˜éŒ„åˆ° CSVï¼ˆè¿½è¸ªç‰ˆæœ¬ï¼‰
log_tracking_to_csv(result)

return result
```

---

### 3. ç§»é™¤ä¸å¿…è¦çš„è¼¸å‡ºå­—æ®µ

#### 3.1 ç§»é™¤ `age` å­—æ®µ

**ä½ç½®**: `mcpclient.py` ç¬¬ 387-393 è¡Œ

**ä¿®æ”¹å‰**:
```python
detections.append({
    "class": class_name,
    "confidence": confidence,
    "bbox": [x1, y1, x2, y2],
    "age": tracked['age']  # âŒ ç§»é™¤
})
```

**ä¿®æ”¹å¾Œ**:
```python
detections.append({
    "class": class_name,
    "confidence": confidence,
    "bbox": [x1, y1, x2, y2]
})
```

**åŸå› **: 
- `age` å­—æ®µåƒ…ç”¨æ–¼å…§éƒ¨è¿½è¸ªé‚è¼¯
- åœ¨ CSV ä¸­å·²ç§»é™¤ï¼Œä¿æŒæ ¼å¼çµ±ä¸€
- ç¯€çœç´„ 5 bytes/ç‰©é«”

---

#### 3.2 ç§»é™¤ `success` å­—æ®µ

**ä½ç½®**: `mcpclient.py` ç¬¬ 429-435 è¡Œ

**ä¿®æ”¹å‰**:
```python
result = {
    "timestamp": datetime.now().isoformat(),
    "success": True,  # âŒ ç§»é™¤
    "detection_count": len(detections),
    "detections": detections,
    "total_time": round(total_time, 3),
    "yolo_inference_time": round(yolo_time, 3)
}
```

**ä¿®æ”¹å¾Œ**:
```python
result = {
    "timestamp": datetime.now().isoformat(),
    "detection_count": len(detections),
    "detections": detections,
    "total_time": round(total_time, 3),
    "yolo_inference_time": round(yolo_time, 3)
}
```

**åŸå› **:
- èˆ‡å…¶ä»–å…©å€‹å·¥å…·ä¿æŒä¸€è‡´ï¼ˆ`detect_stream_frame_simple`ã€`detect_stream_frame_multi` å‡ç„¡æ­¤å­—æ®µï¼‰
- çµ±ä¸€æ•¸æ“šæ ¼å¼
- ç¯€çœç´„ 15 bytes

---

### 4. æ§åˆ¶æ•¸å€¼ç²¾åº¦ï¼ˆå°æ•¸é»å¾Œä¸‰ä½ï¼‰

#### 4.1 ä¿®æ”¹ `detections` æ•¸çµ„

**ä½ç½®**: `mcpclient.py` ç¬¬ 387-393 è¡Œ

**ä¿®æ”¹å‰**:
```python
detections.append({
    "class": class_name,
    "confidence": confidence,  # åŸå§‹ç²¾åº¦ï¼ˆå¯èƒ½ 7-8 ä½å°æ•¸ï¼‰
    "bbox": [x1, y1, x2, y2]   # æ•´æ•¸
})
```

**ä¿®æ”¹å¾Œ**:
```python
detections.append({
    "class": class_name,
    "confidence": round(confidence, 3),  # âœ… 3 ä½å°æ•¸
    "bbox": [round(x1, 3), round(y1, 3), round(x2, 3), round(y2, 3)]  # âœ… 3 ä½å°æ•¸
})
```

#### 4.2 å…¶ä»–æ•¸å€¼å­—æ®µ

**å·²è‡ªå‹•æ§åˆ¶ç²¾åº¦**ï¼ˆç„¡éœ€ä¿®æ”¹ï¼‰:
```python
"total_time": round(total_time, 3),
"yolo_inference_time": round(yolo_time, 3)
```

#### æ•ˆæœ
- **æ•¸æ“šé‡æ¸›å°‘**: æ¯å€‹æ•¸å€¼æ¸›å°‘ç´„ 50% å­—ç¬¦æ•¸
- **æ ¼å¼çµ±ä¸€**: èˆ‡ CSV è¨˜éŒ„æ ¼å¼å®Œå…¨ä¸€è‡´
- **Token ç¯€çœ**: ç´„æ¸›å°‘ 10%

---

## ğŸ“Š å„ªåŒ–æ•ˆæœå°æ¯”

### Token æ¶ˆè€—å°æ¯”ï¼ˆ2 å€‹ç‰©é«”çš„å ´æ™¯ï¼‰

| ç‰ˆæœ¬ | æ•¸æ“šå¤§å° | Token æ¶ˆè€— | æ”¹é€²å¹…åº¦ |
|------|----------|-----------|---------|
| **v1.4ï¼ˆå„ªåŒ–å‰ï¼‰** | ~80 KB | ~20,000 tokens | - |
| **ç§»é™¤ base64 å¾Œ** | ~350 bytes | ~87 tokens | â¬‡ï¸ 99.5% |
| **ç§»é™¤ age å¾Œ** | ~340 bytes | ~85 tokens | â¬‡ï¸ 2.3% |
| **ç§»é™¤ success å¾Œ** | ~330 bytes | ~82 tokens | â¬‡ï¸ 3.5% |
| **v1.5ï¼ˆæ§åˆ¶ç²¾åº¦å¾Œï¼‰** | ~300 bytes | ~74 tokens | â¬‡ï¸ 10% |

### ç¸½é«”å„ªåŒ–
- **å¾ 20,000 tokens â†’ 74 tokens**
- **æ¸›å°‘ 99.6%** ğŸ‰
- **å¯ç”¨æ¬¡æ•¸**: 3 æ¬¡ â†’ **270 æ¬¡** (å¢åŠ  90 å€)

---

## ğŸ“‹ æœ€çµ‚è¿”å›æ ¼å¼

### detect_esp32_stream è¿”å›å€¼
```json
{
    "timestamp": "2025-11-08T15:30:45.123456",
    "detection_count": 2,
    "detections": [
        {
            "class": "cat",
            "confidence": 0.923,
            "bbox": [100.285, 50.123, 250.624, 200.456]
        },
        {
            "class": "dog",
            "confidence": 0.856,
            "bbox": [300.123, 100.456, 450.789, 280.234]
        }
    ],
    "total_time": 1.234,
    "yolo_inference_time": 0.150
}
```

### CSV è¨˜éŒ„æ ¼å¼ (`detection_logs_tracked.csv`)
```csv
timestamp,detection_count,class,confidence,bbox,total_time,yolo_inference_time
2025-11-08T15:30:45.123456,2,cat,0.923,"[100.285, 50.123, 250.624, 200.456]",1.234,0.150
2025-11-08T15:30:45.123456,2,dog,0.856,"[300.123, 100.456, 450.789, 280.234]",1.234,0.150
```

---

## ğŸ”„ ä¸‰å€‹æª¢æ¸¬å·¥å…·å°æ¯”

| ç‰¹æ€§ | detect_stream_frame_simple | detect_stream_frame_multi | detect_esp32_stream (v1.5) |
|------|---------------------------|--------------------------|---------------------------|
| **è™•ç†æ–¹å¼** | å–®å¸§å–®æ¬¡æª¢æ¸¬ | å–®å¸§å–®æ¬¡æª¢æ¸¬ | å¤šå¸§è¿½è¸ªï¼ˆKalman Filterï¼‰ |
| **è¿”å›ç‰©é«”** | åªç¬¬ä¸€å€‹ | æ‰€æœ‰ç‰©é«” | æ‰€æœ‰è¿½è¸ªç‰©é«” |
| **è¿½è¸ªåŠŸèƒ½** | âŒ | âŒ | âœ… |
| **Kalman Filter** | âŒ | âŒ | âœ… |
| **è™•ç†æ™‚é–“** | 0.5-0.8 ç§’ | 0.5-0.8 ç§’ | 1-2 ç§’ |
| **Token æ¶ˆè€—** | ~50 tokens | ~75-125 tokens | ~74 tokens |
| **CSV æ–‡ä»¶** | detection_logs.csv | detection_logs_multi.csv | detection_logs_tracked.csv |
| **é©ç”¨å ´æ™¯** | å ´æ™¯ Aã€Bï¼ˆå–®ç‰©é«”ï¼‰ | å ´æ™¯ Cã€Dï¼ˆå¤šç‰©é«”ï¼‰ | å ´æ™¯ Cã€Dï¼ˆéœ€è¦è¿½è¸ªï¼‰ |

---

## ğŸ’¡ ä½¿ç”¨å»ºè­°

### å ´æ™¯é¸æ“‡

| å¯¦é©—å ´æ™¯ | æ¨è–¦å·¥å…· | åŸå›  |
|---------|---------|------|
| **å ´æ™¯ A: å–®åªè²“** | `detect_stream_frame_simple` | æœ€å¿«é€Ÿï¼Œæœ€çœ token |
| **å ´æ™¯ B: å–®åªç‹—** | `detect_stream_frame_simple` | æœ€å¿«é€Ÿï¼Œæœ€çœ token |
| **å ´æ™¯ C: 1è²“+1ç‹—** | `detect_esp32_stream` | å¤šç‰©é«”è¿½è¸ªï¼ŒKalman å¹³æ»‘ |
| **å ´æ™¯ D: å¤šåªå‹•ç‰©** | `detect_esp32_stream` | å¤šç‰©é«”è¿½è¸ªï¼ŒKalman å¹³æ»‘ |

### å¯¦é©—æµç¨‹å»ºè­°

#### éšæ®µ 1: åŠŸèƒ½é©—è­‰ï¼ˆ2-3 æ¬¡èª¿ç”¨ï¼‰
```
ç›®çš„ï¼šç¢ºèª Kalman Filter è¿½è¸ªæ•ˆæœ
æ–¹æ³•ï¼šäººå·¥è§€å¯Ÿè¿”å›çš„ detections æ•¸æ“š
æ¶ˆè€—ï¼šç´„ 150-220 tokens
```

#### éšæ®µ 2: æ•¸æ“šæ”¶é›†ï¼ˆ40-80 æ¬¡èª¿ç”¨ï¼‰
```
ç›®çš„ï¼šæ”¶é›†å¯¦é©—æ•¸æ“šé€²è¡Œåˆ†æ
æ–¹æ³•ï¼šè‡ªå‹•è¨˜éŒ„åˆ° detection_logs_tracked.csv
æ¶ˆè€—ï¼šç´„ 2,960-5,920 tokens
```

#### éšæ®µ 3: æ•¸æ“šåˆ†æ
```
å·¥å…·ï¼šPython pandas åˆ†æ CSV æ–‡ä»¶
æŒ‡æ¨™ï¼šæª¢æ¸¬æº–ç¢ºç‡ã€è¿½è¸ªç©©å®šæ€§ã€è™•ç†æ™‚é–“
```

---

## ğŸ¯ ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½

é›–ç„¶é€²è¡Œäº†å¤§é‡å„ªåŒ–ï¼Œä½†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½**å®Œå…¨ä¿ç•™**ï¼š

### âœ… è¿½è¸ªåŠŸèƒ½
- Kalman Filter è¿½è¸ª
- ç‰©é«”å¹´é½¡ç®¡ç† (`max_age`)
- é¡¯ç¤ºå®¹å¿åº¦ (`display_tolerance`)
- å¤šç‰©é«”åŒæ™‚è¿½è¸ª

### âœ… ç¹ªè£½åŠŸèƒ½
- é‚Šç•Œæ¡†ç¹ªè£½ (`cv2.rectangle`)
- æ¨™ç±¤ç¹ªè£½ (`cv2.putText`)
- å®Œæ•´çš„ `annotated_frame` ç”Ÿæˆ
- å¯é¸ï¼šæ·»åŠ  `cv2.imwrite()` ä¿å­˜åˆ°æœ¬åœ°

### âœ… æª¢æ¸¬åŠŸèƒ½
- YOLO ç‰©é«”æª¢æ¸¬
- å¤šå¹€è™•ç†ï¼ˆ`frames_to_process`ï¼‰
- è·³å¹€å„ªåŒ–ï¼ˆ`frame_skip`ï¼‰
- GPU åŠ é€Ÿæ”¯æŒ

### âœ… æ•¸æ“šè¨˜éŒ„
- è‡ªå‹• CSV è¨˜éŒ„
- å®Œæ•´çš„æ™‚é–“æˆ³è¨˜
- æ‰€æœ‰æª¢æ¸¬ç‰©é«”ä¿¡æ¯
- æ€§èƒ½æŒ‡æ¨™ï¼ˆè™•ç†æ™‚é–“ã€æ¨ç†æ™‚é–“ï¼‰

---

## ğŸ“ ä»£ç¢¼è®Šæ›´æ‘˜è¦

### æ–°å¢å…§å®¹
1. âœ… `log_tracking_to_csv()` å‡½æ•¸ï¼ˆ49 è¡Œï¼‰
2. âœ… CSV è‡ªå‹•è¨˜éŒ„èª¿ç”¨

### åˆªé™¤å…§å®¹
1. âŒ Base64 åœ–åƒç·¨ç¢¼é‚è¼¯ï¼ˆ7 è¡Œï¼‰
2. âŒ `age` å­—æ®µè¼¸å‡º
3. âŒ `success` å­—æ®µè¼¸å‡º

### ä¿®æ”¹å…§å®¹
1. ğŸ”§ `confidence` ç²¾åº¦æ§åˆ¶ï¼š`round(confidence, 3)`
2. ğŸ”§ `bbox` ç²¾åº¦æ§åˆ¶ï¼š`[round(x, 3) for x in bbox]`

### ç¸½è®Šæ›´é‡
- **æ–°å¢**: ~55 è¡Œ
- **åˆªé™¤**: ~10 è¡Œ
- **ä¿®æ”¹**: ~5 è¡Œ
- **æ·¨å¢åŠ **: ~50 è¡Œ

---

## ğŸš€ éƒ¨ç½²èªªæ˜

### é‡å•Ÿ Claude Desktop
```
1. å®Œå…¨é€€å‡º Claude Desktop
2. ç­‰å¾… 15 ç§’
3. é‡æ–°å•Ÿå‹• Claude Desktop
4. ç­‰å¾… 30 ç§’è®“ MCP æœå‹™å™¨åˆå§‹åŒ–
```

### é©—è­‰å„ªåŒ–
```
# æ¸¬è©¦å‘½ä»¤
è«‹ä½¿ç”¨ detect_esp32_stream å·¥å…·åµæ¸¬ä¸²æµ

# é æœŸçµæœ
- è¿”å›æ™‚é–“ < 2 ç§’
- è¿”å›æ•¸æ“šåŒ…å«æ‰€æœ‰è¿½è¸ªç‰©é«”
- è‡ªå‹•ç”Ÿæˆ detection_logs_tracked.csv
- æ²’æœ‰ base64 åœ–åƒæ•¸æ“š
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- `v1.0_workflow.md` - åŸºç¤å·¥ä½œæµç¨‹
- `v1.1_workflow.md` - æ”¹é€²çš„å·¥ä½œæµç¨‹
- `v1.2_mcpclient_test.md` - MCP å®¢æˆ¶ç«¯æ¸¬è©¦
- `v1.2_stream_synctest.md` - ä¸²æµåŒæ­¥æ¸¬è©¦
- `mcp_tools_usage_guide.md` - MCP å·¥å…·ä½¿ç”¨æŒ‡å—

---

## ğŸŠ ç¸½çµ

v1.5 ç‰ˆæœ¬æˆåŠŸå°‡ `detect_esp32_stream` å¾**é«˜æ¶ˆè€—å·¥å…·**è½‰è®Šç‚º**è¼•é‡ç´šè¿½è¸ªå·¥å…·**ï¼š

1. **99.6% Token ç¯€çœ** - è®“å¯¦é©—æ•¸æ“šæ”¶é›†è®Šå¾—å¯è¡Œ
2. **å®Œæ•´åŠŸèƒ½ä¿ç•™** - Kalman Filter è¿½è¸ªã€ç¹ªè£½åŠŸèƒ½å…¨éƒ¨ä¿ç•™
3. **æ ¼å¼çµ±ä¸€** - èˆ‡å…¶ä»–å…©å€‹å·¥å…·æ•¸æ“šæ ¼å¼ä¸€è‡´
4. **è‡ªå‹•è¨˜éŒ„** - ç„¡éœ€æ‰‹å‹•è™•ç†ï¼Œç›´æ¥ç”Ÿæˆ CSV å¯¦é©—æ•¸æ“š

**é©ç”¨æ–¼å°ˆé¡Œç ”ç©¶ç›®æ¨™**: å³æ™‚è¿½è¸ªè²“ç‹—çš„æ•ˆèƒ½åˆ†æèˆ‡æº–ç¢ºåº¦è©•ä¼° âœ…
