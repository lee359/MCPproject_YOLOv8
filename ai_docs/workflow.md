# YOLOv8 MCP Server 系統運作流程圖

## 📊 系統架構概述

本文檔詳細描述了基於 Model Context Protocol (MCP) 的 YOLOv8 物體偵測系統的完整運作流程。

---

## 🔄 完整雙向通訊流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                        Claude Desktop (用戶界面)                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 用戶輸入: "使用 detect_esp32_stream 偵測畫面"             │   │
│  └──────────────────────┬───────────────────────────────────┘   │
└─────────────────────────┼─────────────────────────────────────────┘
                          │
                          ↓ ① 工具調用請求 (JSON-RPC)
                          ↑ ⑥ 回傳結果 (JSON)
                          │
┌─────────────────────────┼─────────────────────────────────────────┐
│              MCP 協議層 (Model Context Protocol)                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  配置: claude_desktop_config.json                         │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ "command": "python.exe"                             │  │  │
│  │  │ "args": ["mcpclient.py"]                            │  │  │
│  │  │ "env": {"PYTHONPATH": "..."}                        │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │  進程管理: 啟動/監控/重啟子進程                            │  │
│  │  通訊協議: stdio (標準輸入/輸出)                           │  │
│  │  數據格式: JSON-RPC 2.0                                   │  │
│  └────────────────────┬──────────────────────────────────────┘  │
└─────────────────────────┼─────────────────────────────────────────┘
                          │
                          ↓ ② JSON 請求 (stdin)
                          ↑ ⑤ JSON 回應 (stdout)
                          │
┌─────────────────────────┼─────────────────────────────────────────┐
│          MCP Server (mcpclient.py) - 本地 Python 進程            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  FastMCP 框架                                             │  │
│  │  ├─ @mcp.tool() detect_esp32_stream()  ← 主要工具        │  │
│  │  ├─ @mcp.tool() detect_stream_frame_simple()             │  │
│  │  ├─ @mcp.tool() check_stream_health()                    │  │
│  │  └─ @mcp.tool() detect_image()                           │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │  初始化組件:                                              │  │
│  │  ├─ YOLO 模型載入 (best.pt)                              │  │
│  │  ├─ GPU/CPU 設備選擇                                     │  │
│  │  └─ Kalman Filter 系統                                   │  │
│  └────────────────────┬──────────────────────────────────────┘  │
└─────────────────────────┼─────────────────────────────────────────┘
                          │
                          ↓ ③ HTTP GET 請求 (持續連接)
                          ↑ ④ MJPEG 視頻流 (持續傳輸)
                          │
┌─────────────────────────┼─────────────────────────────────────────┐
│            ESP32-CAM (獨立硬體設備 - 區域網路)                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  網路配置:                                                │  │
│  │  ├─ IP: 192.168.0.103                                    │  │
│  │  ├─ Port: 81                                             │  │
│  │  └─ Endpoint: /stream                                    │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │  硬體組件:                                                │  │
│  │  ├─ OV2640 攝像頭模組                                     │  │
│  │  ├─ ESP32 微控制器                                        │  │
│  │  └─ WiFi 無線網卡                                         │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │  視頻流規格:                                              │  │
│  │  ├─ 格式: MJPEG (Motion JPEG)                            │  │
│  │  ├─ 解析度: 可調整 (通常 640x480 或更高)                  │  │
│  │  └─ 幀率: ~30 FPS                                        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔧 影像處理流程 (mcpclient.py 內部)

```
═══════════════════════════════════════════════════════════════════
                    影像處理流程 (mcpclient.py 內部)
═══════════════════════════════════════════════════════════════════

┌───────────────────────────────────────────────────────────────┐
│ Step 1: 視頻流接收與解碼                                       │
│  ├─ cv2.VideoCapture(stream_url)  ← 建立連接                 │
│  ├─ cap.set(CAP_PROP_BUFFERSIZE, 1)  ← 最小化延遲            │
│  ├─ cap.read()  ← 讀取影像幀                                  │
│  └─ 幀跳過控制 (frame_skip)  ← 調整處理速度                  │
└───────────────────────────────────────────────────────────────┘
                          ↓
┌───────────────────────────────────────────────────────────────┐
│ Step 2: YOLO 物體偵測                                          │
│  ├─ model.predict(frame, imgsz, conf)  ← YOLOv8 推論         │
│  ├─ 輸出: boxes, classes, confidences                        │
│  └─ 過濾低信心度檢測 (conf threshold)                         │
└───────────────────────────────────────────────────────────────┘
                          ↓
┌───────────────────────────────────────────────────────────────┐
│ Step 3: Kalman Filter 物體追蹤 (可選)                         │
│  ├─ 預測下一幀位置: kf.predict()                              │
│  ├─ 數據關聯: 匹配檢測與追蹤物體                              │
│  ├─ 更新狀態: kf.update(measurement)                         │
│  ├─ 年齡管理: age++ (未匹配), age=0 (已匹配)                 │
│  └─ 移除舊物體: age > max_age                                │
└───────────────────────────────────────────────────────────────┘
                          ↓
┌───────────────────────────────────────────────────────────────┐
│ Step 4: 視覺化渲染                                             │
│  ├─ 繪製邊界框: cv2.rectangle()                               │
│  ├─ 添加標籤: cv2.putText(class, confidence)                 │
│  ├─ 濾除閃爍: 只顯示 age <= display_tolerance 的物體          │
│  └─ 生成標註圖像: annotated_frame                             │
└───────────────────────────────────────────────────────────────┘
                          ↓
┌───────────────────────────────────────────────────────────────┐
│ Step 5: 數據編碼與封裝                                         │
│  ├─ JPEG 編碼: cv2.imencode('.jpg')                          │
│  ├─ Base64 編碼: base64.b64encode()                          │
│  └─ JSON 封裝: {success, detections, image_base64, ...}      │
└───────────────────────────────────────────────────────────────┘
```

---

## 🔄 雙向通訊詳解

### 1. Claude Desktop ↔ MCP 協議層

```
↓ 請求方向:
  - 用戶點擊工具調用
  - Claude Desktop 生成 JSON-RPC 請求
  - 寫入子進程的 stdin

↑ 回應方向:
  - MCP Server 處理完成
  - 將 JSON 結果寫入 stdout
  - Claude Desktop 讀取並解析
```

**持續性**: 每次工具調用都會觸發一次雙向通訊

**JSON-RPC 請求範例**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "detect_esp32_stream",
    "arguments": {
      "imgsz": 416,
      "conf": 0.25,
      "frame_skip": 1,
      "use_kalman": true
    }
  }
}
```

**JSON 回應範例**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "success": true,
    "detections": [
      {
        "class": "person",
        "confidence": 0.87,
        "bbox": [100, 150, 300, 450]
      }
    ],
    "annotated_image_base64": "iVBORw0KG...",
    "performance": {
      "total_time": 1.23,
      "predict_time": 0.45
    }
  }
}
```

---

### 2. MCP Server ↔ ESP32-CAM

```
↓ 請求方向:
  - cv2.VideoCapture() 建立 HTTP 連接
  - 持續的 GET 請求保持連接

↑ 數據流方向:
  - ESP32-CAM 持續推送 MJPEG 幀
  - OpenCV 持續讀取並解碼
```

**持續性**: 在單次工具調用中，可能讀取多幀（frame_skip 參數控制）

**HTTP 請求**:
```
GET /stream HTTP/1.1
Host: 192.168.0.103:81
Connection: keep-alive
```

**MJPEG 流格式**:
```
--frame
Content-Type: image/jpeg
Content-Length: 12345

[JPEG 二進制數據]
--frame
Content-Type: image/jpeg
Content-Length: 12456

[JPEG 二進制數據]
...
```

---

## 📊 完整數據流時序圖

```
用戶動作               Claude Desktop          MCP Server          ESP32-CAM
   │                        │                      │                   │
   │ 1. 呼叫工具             │                      │                   │
   ├──────────────────────→ │                      │                   │
   │                        │ 2. 發送 JSON 請求     │                   │
   │                        ├─────────────────────→│                   │
   │                        │                      │ 3. 連接串流        │
   │                        │                      ├──────────────────→│
   │                        │                      │ 4a. 讀取幀 1       │
   │                        │                      │←──────────────────┤
   │                        │                      │ 4b. 讀取幀 2       │
   │                        │                      │←──────────────────┤
   │                        │                      │ 4c. 讀取幀 N       │
   │                        │                      │←──────────────────┤
   │                        │                      │ 5. 關閉連接        │
   │                        │                      ├─────────────────→ │
   │                        │ 6. 回傳 JSON 結果     │                   │
   │                        │←─────────────────────┤                   │
   │ 7. 顯示結果             │                      │                   │
   │←────────────────────── │                      │                   │
   │                        │                      │                   │
```

---

## 🔑 關鍵技術要點

### 1. MCP 通訊機制
- **協議**: JSON-RPC 2.0
- **傳輸**: stdio (標準輸入/輸出)
- **格式**: 每條訊息以換行符分隔的 JSON
- **重要**: stdout 只能用於 MCP JSON 通訊，其他輸出必須使用 stderr

### 2. 進程架構
```
Claude Desktop (主進程)
    └─> 啟動 python.exe mcpclient.py (子進程)
        └─> 連接 ESP32-CAM (HTTP 客戶端)
```

### 3. 數據流向
```
用戶請求 → MCP JSON → Python 函數 → HTTP 請求 → ESP32-CAM
                                                      │
用戶查看 ← MCP JSON ← Python 回應 ← YOLO 推論 ← 影像幀 ←┘
```

### 4. 關鍵組件
| 組件 | 類型 | 功能 |
|------|------|------|
| Claude Desktop | MCP 客戶端 | 用戶界面、工具調用、結果顯示 |
| mcpclient.py | MCP 服務器 | 工具實現、YOLO 推論、影像處理 |
| ESP32-CAM | 硬體設備 | 視頻採集、網路串流 |
| YOLOv8 | AI 模型 | 物體偵測 |
| Kalman Filter | 追蹤演算法 | 物體追蹤、減少閃爍 |

---

## 🛠️ 可用工具列表

### 1. detect_esp32_stream()
**主要功能**: 從 ESP32-CAM 進行完整的物體偵測與追蹤

**參數**:
- `stream_url`: 串流 URL（預設: http://192.168.0.103:81/stream）
- `imgsz`: 圖像大小（預設: 416）
- `conf`: 信心閾值（預設: 0.25）
- `frame_skip`: 跳幀數量（預設: 1）
- `max_age`: 物體最大存活幀數（預設: 5）
- `display_tolerance`: 顯示容忍幀數（預設: 3）
- `use_kalman`: 是否使用 Kalman Filter（預設: True）

**返回**:
- 偵測結果列表
- Base64 編碼的標註圖像
- 性能統計資訊

---

### 2. detect_stream_frame_simple()
**主要功能**: 簡化版串流偵測（不返回圖像，速度更快）

**參數**:
- `stream_url`: 串流 URL
- `imgsz`: 圖像大小（預設: 416）
- `conf`: 信心閾值（預設: 0.3）

**返回**:
- 偵測結果列表（不含圖像）

---

### 3. check_stream_health()
**主要功能**: 診斷串流連接狀態

**參數**:
- `stream_url`: 串流 URL

**返回**:
- HTTP 連接狀態
- OpenCV 讀取狀態
- 連接時間統計

---

### 4. detect_image()
**主要功能**: 對本地圖片進行物體偵測

**參數**:
- `image_path`: 圖片路徑
- `imgsz`: 圖像大小（預設: 640）
- `conf`: 信心閾值（預設: 0.3）

**返回**:
- 偵測結果列表
- Base64 編碼的標註圖像

---

## 💡 系統特點

### ✅ 優勢
1. **低延遲**: 緩衝區設置為 1，最小化延遲
2. **穩定追蹤**: Kalman Filter 減少檢測框閃爍
3. **靈活調整**: 多參數可調整（FPS、信心度、追蹤參數）
4. **GPU 加速**: 自動偵測並使用 CUDA（如果可用）
5. **診斷工具**: 提供健康檢查工具快速排查問題

### 🎯 應用場景
1. **即時監控**: 使用 `detect_esp32_stream()` 進行持續偵測
2. **快速查詢**: 使用 `detect_stream_frame_simple()` 獲取簡單結果
3. **系統診斷**: 使用 `check_stream_health()` 排查連接問題
4. **靜態分析**: 使用 `detect_image()` 處理本地圖片

---

## 🚀 性能優化

### FPS 調整建議
- `frame_skip=1`: 全速檢測（30 FPS → 30 FPS）
- `frame_skip=5`: 平衡模式（30 FPS → 6 FPS）
- `frame_skip=15`: 節能模式（30 FPS → 2 FPS）
- `frame_skip=30`: 低速模式（30 FPS → 1 FPS）

### 閃爍控制
- `max_age`: 控制物體保留時間（建議 5-20）
- `display_tolerance`: 控制顯示容忍度（建議 3-7）

### 信心度設置
- 高精度場景: `conf=0.5`
- 平衡場景: `conf=0.25-0.3`
- 高召回場景: `conf=0.15-0.2`

---

## 📝 正確的流程描述

**完整版**:
> 用戶在 Claude Desktop 呼叫 `detect_esp32_stream` 工具 → Claude Desktop 透過 MCP 協議（stdio）啟動並與本地 Python 程序 `mcpclient.py` 通訊 → `mcpclient.py` 連接到區域網路中的 ESP32-CAM 硬體設備並獲取影像串流 → OpenCV 讀取影像後由 YOLOv8 模型進行物體偵測，並使用 Kalman Filter 進行追蹤 → 結果通過 MCP 協議（JSON格式）回傳給 Claude Desktop → 用戶看到檢測結果和標註圖像

**關鍵修正**:
- ❌ 不是連接到 VSCode → ✅ 是獨立的 Python 進程
- ❌ 不是"啟動" ESP32-CAM → ✅ ESP32-CAM 已在運行，只是連接它
- ❌ 不是一般的 API 調用 → ✅ 是透過 MCP 協議的 stdio 通訊

---

## 📚 相關文檔

- [MCP 實現技術報告](mcp_implementation_technical_report.md)
- [MCP 工具使用指南](mcp_tools_usage_guide.md)
- [串流同步優化](stream_sync_optimization.md)
- [Claude Desktop 設置指南](claude_desktop_setup_guide.md)

---

**文檔版本**: v1.0  
**最後更新**: 2025-11-05  
**作者**: YOLOv8 MCP Server Team
