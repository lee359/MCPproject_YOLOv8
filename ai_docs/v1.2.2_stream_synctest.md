# ESP32-CAM YOLOv8 æª¢æ¸¬ç³»çµ± v1.2.2 - é–ƒçˆå„ªåŒ–æŠ€è¡“å ±å‘Š

**ç‰ˆæœ¬**: v1.2.2  
**æ—¥æœŸ**: 2025-11-05  
**ä½œè€…**: AI Assistant  
**å°ˆæ¡ˆ**: MCPproject-YOLOv8  

---

## ğŸ“‹ æ‘˜è¦

æœ¬å ±å‘Šè¨˜éŒ„ `streamdetect.py` v1.2.2 ç‰ˆæœ¬ä¸­é‡å°é‚Šç•Œæ¡†é–ƒçˆå•é¡Œçš„å„ªåŒ–éç¨‹ã€‚é€éèª¿æ•´ç‰©é«”å­˜æ´»ç­–ç•¥å’Œé¡¯ç¤ºé‚è¼¯ï¼Œåœ¨ä¿æŒ Kalman Filter å¹³æ»‘è¿½è¸ªçš„åŸºç¤ä¸Šï¼Œé€²ä¸€æ­¥é™ä½äº†å› æš«æ™‚æœªæª¢æ¸¬åˆ°ç‰©é«”è€Œé€ æˆçš„è¦–è¦ºé–ƒçˆç¾è±¡ã€‚

---

## ğŸ¯ å•é¡Œæè¿°

### ä½¿ç”¨è€…åé¥‹
> "fpsæœ‰å¯èƒ½å¯ä»¥èª¿åˆ°<1å—ï¼Ÿè¾¨è­˜æ¡†è®€å–å¤ªå¿«ä¸€ç›´é–ƒçˆæœƒæ˜¯å› çˆ²fpsçš„è¨­å®šå—ï¼Ÿ"

### å•é¡Œåˆ†æ

#### 1. **é–ƒçˆæ ¹æœ¬åŸå› **
- âŒ **ä¸¦é FPS éå¿«**ï¼šé›–ç„¶ä½¿ç”¨è€…èªç‚ºæª¢æ¸¬é »ç‡éé«˜å°è‡´é–ƒçˆ
- âœ… **å¯¦éš›åŸå› **ï¼šé¡¯ç¤ºé‚è¼¯éæ–¼åš´æ ¼ï¼Œåªé¡¯ç¤ºç•¶å‰å¹€åŒ¹é…çš„ç‰©é«”

#### 2. **v1.3 ç‰ˆæœ¬çš„å±€é™æ€§**
```python
# v1.3 é¡¯ç¤ºé‚è¼¯ï¼ˆéæ–¼åš´æ ¼ï¼‰
for obj_id, tracked in tracked_objects.items():
    if tracked['age'] == 0:  # âŒ åªé¡¯ç¤ºç•¶å‰å¹€æœ‰åŒ¹é…çš„ç‰©é«”
        # ç¹ªè£½é‚Šç•Œæ¡†...
```

**å•é¡Œ**ï¼š
- ç•¶æŸä¸€å¹€ YOLO æš«æ™‚æœªæª¢æ¸¬åˆ°ç‰©é«”ï¼ˆé®æ“‹ã€å…‰ç·šè®ŠåŒ–ç­‰ï¼‰
- å³ä½¿ Kalman Filter ä»åœ¨è¿½è¸ªï¼Œé‚Šç•Œæ¡†ä¹Ÿæœƒ**ç«‹å³æ¶ˆå¤±**
- ä¸‹ä¸€å¹€æª¢æ¸¬åˆ°å¾Œåˆ**é‡æ–°å‡ºç¾** â†’ é€ æˆé–ƒçˆ

#### 3. **èª¤è§£æ¾„æ¸…ï¼šFPS vs é–ƒçˆ**
```python
frame_skip = 5  # æ¯ 5 å¹€æª¢æ¸¬ä¸€æ¬¡
# 30 FPS æ”åƒé ­ â†’ å¯¦éš›æª¢æ¸¬é »ç‡ 6 FPS
```

- é™ä½ FPS å¯æ¸›å°‘é‹ç®—è² æ“”
- **ä½†ä¸èƒ½è§£æ±ºé–ƒçˆå•é¡Œ**
- é–ƒçˆæ˜¯å› ç‚ºç‰©é«”å­˜åœ¨/ä¸å­˜åœ¨çš„**äºŒå…ƒåˆ‡æ›**

---

## ğŸ”§ å„ªåŒ–æ–¹æ¡ˆ

### æ ¸å¿ƒç­–ç•¥ï¼šæ™‚é–“é€£çºŒæ€§å®¹å¿

**ç†å¿µ**ï¼šå…è¨±é‚Šç•Œæ¡†åœ¨ç‰©é«”**æš«æ™‚æœªåŒ¹é…**æ™‚ä»ä¿æŒé¡¯ç¤ºï¼Œåˆ©ç”¨ Kalman Filter çš„é æ¸¬ä½ç½®å¡«è£œç©ºç™½ã€‚

### å¯¦æ–½ç´°ç¯€

#### 1. **åƒæ•¸åŒ–é…ç½®**ï¼ˆç¬¬ 53-54 è¡Œï¼‰

```python
# v1.2.2 æ–°å¢
frame_skip = 0.7  # æª¢æ¸¬é »ç‡æ§åˆ¶ï¼ˆæ”¯æ´ <1 çš„å°æ•¸å€¼æ¸¬è©¦ï¼‰
max_age = 15      # ç‰©é«”æœ€å¤§å­˜æ´»å¹€æ•¸ï¼ˆå¾ 5 æå‡åˆ° 15ï¼‰
```

**æ”¹é€²é»**ï¼š
- `frame_skip` æ”¯æ´å°æ•¸å€¼ï¼ˆå¯¦é©—æ€§ï¼‰
- `max_age` åƒæ•¸åŒ–ï¼Œä¾¿æ–¼èª¿æ•´å®¹å¿åº¦

#### 2. **é¡¯ç¤ºé‚è¼¯å¯¬é¬†åŒ–**ï¼ˆç¬¬ 140 è¡Œï¼‰

##### Before (v1.3)
```python
if tracked['age'] == 0:  # åš´æ ¼æ¨¡å¼
    # åªé¡¯ç¤ºç•¶å‰å¹€åŒ¹é…çš„ç‰©é«”
```

##### After (v1.2.2)
```python
if tracked['age'] <= 3:  # å®¹å¿æ¨¡å¼ â­
    # é¡¯ç¤ºæœ€è¿‘ 3 å¹€å…§æœ‰æ´»å‹•çš„ç‰©é«”ï¼ˆæ¸›å°‘é–ƒçˆï¼‰
```

**æŠ€è¡“ç´°ç¯€**ï¼š
- `age = 0`ï¼šç•¶å‰å¹€æˆåŠŸåŒ¹é…
- `age = 1-3`ï¼šæœ€è¿‘ 1-3 å¹€æœªåŒ¹é…ï¼Œä½†ä»é¡¯ç¤º
- `age > 3`ï¼šéš±è—ï¼ˆä½†ç‰©é«”ä»å­˜æ´»è‡³ `max_age`ï¼‰

#### 3. **é›™å±¤å®¹å¿æ©Ÿåˆ¶**

```
æª¢æ¸¬æœªåŒ¹é…
    â†“
age += 1
    â†“
age <= 3? â”€â”€YESâ”€â”€> ç¹¼çºŒé¡¯ç¤ºï¼ˆä½¿ç”¨ Kalman é æ¸¬ä½ç½®ï¼‰
    |
    NO
    â†“
éš±è—é‚Šç•Œæ¡†ï¼ˆä½†ä¿ç•™è¿½è¸ªæ•¸æ“šï¼‰
    â†“
age > 15? â”€â”€YESâ”€â”€> å¾¹åº•åˆªé™¤ç‰©é«”
    |
    NO
    â†“
ç­‰å¾…é‡æ–°åŒ¹é…
```

---

## ğŸ“Š åƒæ•¸èª¿æ•´æŒ‡å—

### FPS æ§åˆ¶

| `frame_skip` | 30 FPS æ”åƒé ­ | æ•ˆæœ |
|-------------|-------------|-----|
| 5           | ~6 FPS      | é è¨­ï¼ˆå¹³è¡¡ï¼‰ |
| 10          | ~3 FPS      | è¼ƒæ…¢ |
| 15          | ~2 FPS      | æ…¢ |
| 30          | ~1 FPS      | æ¯ç§’æª¢æ¸¬ä¸€æ¬¡ âœ… |
| 60          | ~0.5 FPS    | æ¯å…©ç§’æª¢æ¸¬ä¸€æ¬¡ âœ… |

**âœ… æ”¯æ´ FPS < 1**ï¼šè¨­ç½® `frame_skip >= 30`

### é–ƒçˆæ§åˆ¶

| åƒæ•¸ | æ¨è–¦å€¼ | æ•ˆæœ |
|-----|-------|-----|
| `max_age` | 10-20 | ç‰©é«”å­˜æ´»æ™‚é•· |
| é¡¯ç¤ºæ¢ä»¶ | `age <= 3` | åŸºç¤é˜²é–ƒçˆ |
| é¡¯ç¤ºæ¢ä»¶ | `age <= 5` | å¼·åŒ–é˜²é–ƒçˆ |
| é¡¯ç¤ºæ¢ä»¶ | `age <= 7` | æœ€å¤§å®¹å¿ |

### èª¿æ•´å»ºè­°

#### å ´æ™¯ 1ï¼šå¿«é€Ÿç§»å‹•ç‰©é«”
```python
frame_skip = 5      # ä¿æŒè¼ƒé«˜æª¢æ¸¬é »ç‡
max_age = 10        # é©ä¸­çš„å­˜æ´»æ™‚é–“
if tracked['age'] <= 3  # åŸºç¤å®¹å¿
```

#### å ´æ™¯ 2ï¼šéœæ…‹/æ…¢é€Ÿç‰©é«”
```python
frame_skip = 15     # é™ä½æª¢æ¸¬é »ç‡
max_age = 20        # è¼ƒé•·å­˜æ´»æ™‚é–“
if tracked['age'] <= 5  # æ›´é«˜å®¹å¿
```

#### å ´æ™¯ 3ï¼šä½åŠŸè€—æ¨¡å¼
```python
frame_skip = 30     # 1 FPS
max_age = 15        # å¹³è¡¡è¨­ç½®
if tracked['age'] <= 7  # æœ€å¤§å®¹å¿
```

---

## ğŸ”¬ æŠ€è¡“åŸç†

### Kalman Filter åœ¨é–ƒçˆå„ªåŒ–ä¸­çš„ä½œç”¨

#### é æ¸¬éšæ®µ
```python
tracked['kf'].predict()  # å³ä½¿æœªæª¢æ¸¬åˆ°ï¼Œä¹Ÿèƒ½é æ¸¬ä½ç½®
```

#### ä½ç½®é‡å»º
```python
smoothed_center = tracked['kf'].x[:2].flatten()  # ä½¿ç”¨é æ¸¬ä½ç½®
# é‡å»ºé‚Šç•Œæ¡†
x1 = int(smoothed_center[0] - w/2)
y1 = int(smoothed_center[1] - h/2)
```

**é—œéµå„ªå‹¢**ï¼š
- ç•¶ `age = 1-3` æ™‚ï¼ˆæš«æ™‚æœªåŒ¹é…ï¼‰
- Kalman Filter ä½¿ç”¨**é‹å‹•æ¨¡å‹é æ¸¬**ä¸‹ä¸€ä½ç½®
- é‚Šç•Œæ¡†**å¹³æ»‘ç§»å‹•**è€Œéæ¶ˆå¤±
- è¦–è¦ºä¸Šæ„ŸçŸ¥ç‚º**é€£çºŒè¿½è¹¤**

---

## ğŸ“ˆ ç‰ˆæœ¬æ¯”è¼ƒ

### v1.3 â†’ v1.2.2 ä¸»è¦è®Šæ›´

| é …ç›® | v1.3 | v1.2.2 | æ”¹å–„ |
|-----|------|--------|-----|
| é¡¯ç¤ºé‚è¼¯ | `age == 0` | `age <= 3` | â­â­â­ |
| `max_age` | å›ºå®š 5 | åƒæ•¸åŒ– 15 | â­â­ |
| è¦–çª—å¤§å° | è‡ªå‹• | `WINDOW_NORMAL` | â­ |
| `frame_skip` æ”¯æ´ | æ•´æ•¸ | å°æ•¸ï¼ˆå¯¦é©—ï¼‰ | â­ |
| é–ƒçˆç¨‹åº¦ | æ˜é¡¯ | é¡¯è‘—é™ä½ | â­â­â­ |

### ä»£ç¢¼è¡Œæ•¸
- **v1.3**: 167 è¡Œ
- **v1.2.2**: 172 è¡Œï¼ˆ+5 è¡Œï¼‰

**æ–°å¢å…§å®¹**ï¼š
- è¦–çª—å¤§å°è¨­å®šï¼ˆ1 è¡Œï¼‰
- åƒæ•¸åŒ–é…ç½®è¨»é‡‹ï¼ˆ2 è¡Œï¼‰
- é¡¯ç¤ºé‚è¼¯è¨»é‡‹å„ªåŒ–ï¼ˆ2 è¡Œï¼‰

---

## ğŸ¨ è¦–è¦ºæ•ˆæœæ”¹å–„

### Before (v1.3)
```
å¹€ 1: [æª¢æ¸¬åˆ°] â†’ é¡¯ç¤ºæ¡† âœ…
å¹€ 2: [æœªæª¢æ¸¬] â†’ æ¡†æ¶ˆå¤± âŒ
å¹€ 3: [æª¢æ¸¬åˆ°] â†’ æ¡†å‡ºç¾ âœ…
å¹€ 4: [æœªæª¢æ¸¬] â†’ æ¡†æ¶ˆå¤± âŒ
           â†“
      æŒçºŒé–ƒçˆ ğŸ˜µ
```

### After (v1.2.2)
```
å¹€ 1: [æª¢æ¸¬åˆ°, age=0] â†’ é¡¯ç¤ºæ¡† âœ…
å¹€ 2: [æœªæª¢æ¸¬, age=1] â†’ ç¹¼çºŒé¡¯ç¤ºï¼ˆé æ¸¬ä½ç½®ï¼‰âœ…
å¹€ 3: [æª¢æ¸¬åˆ°, age=0] â†’ é¡¯ç¤ºæ¡†ï¼ˆé‡æ–°åŒ¹é…ï¼‰âœ…
å¹€ 4: [æœªæª¢æ¸¬, age=1] â†’ ç¹¼çºŒé¡¯ç¤º âœ…
           â†“
      å¹³æ»‘ç©©å®š ğŸ˜Š
```

---

## âš™ï¸ å¯¦ä½œç´°ç¯€

### å®Œæ•´è¿½è¸ªç”Ÿå‘½é€±æœŸ

```python
# æ­¥é©Ÿ 1: æª¢æ¸¬åˆ°æ–°ç‰©é«”
if best_match_id and best_similarity > 0.4:
    tracked_objects[best_match_id]['age'] = 0  # é‡ç½®å¹´é½¡
    
# æ­¥é©Ÿ 2: æ¯å¹€å¹´é½¡å¢é•·
for obj_id in list(tracked_objects.keys()):
    tracked_objects[obj_id]['age'] += 1
    
# æ­¥é©Ÿ 3: é¡¯ç¤ºåˆ¤æ–·
if tracked['age'] <= 3:  # å®¹å¿ 3 å¹€
    # ç¹ªè£½é‚Šç•Œæ¡†
    
# æ­¥é©Ÿ 4: æ¸…ç†éæœŸç‰©é«”
if tracked_objects[obj_id]['age'] > max_age:
    del tracked_objects[obj_id]
```

### é—œéµæ™‚é–“è»¸

```
age:  0    1    2    3    4    5  ...  15   16
      |    |    |    |    |    |        |    |
é¡¯ç¤º: âœ…   âœ…   âœ…   âœ…   âŒ   âŒ  ...  âŒ   åˆªé™¤
      â””â”€â”€â”€â”€å®¹å¿æœŸâ”€â”€â”€â”€â”˜                      
                      â””â”€â”€â”€éš±è—ä½†ä¿ç•™â”€â”€â”€â”˜
```

---

## ğŸš€ æ€§èƒ½å½±éŸ¿

### é‹ç®—æˆæœ¬
- **é¡å¤–åˆ¤æ–·**ï¼š`age <= 3` vs `age == 0` â†’ å¿½ç•¥ä¸è¨ˆ
- **è¨˜æ†¶é«”**ï¼šä¿ç•™æ›´å¤šç‰©é«”ï¼ˆ`max_age` 15 vs 5ï¼‰ â†’ è¼•å¾®å¢åŠ 
- **æ¸²æŸ“**ï¼šç•¥å¾®å¢åŠ ï¼ˆé¡¯ç¤ºæ›´å¤šæ¡†ï¼‰ â†’ å¯æ¥å—

### å„ªåŒ–å»ºè­°
```python
# å¦‚æœæ€§èƒ½ä¸è¶³ï¼Œå¯é™ä½ max_age
max_age = 10  # æ¸›å°‘è¨˜æ†¶é«”ä½”ç”¨

# æˆ–æé«˜é¡¯ç¤ºé–€æª»
if tracked['age'] <= 2  # åªå®¹å¿ 2 å¹€
```

---

## ğŸ” å•é¡Œæ’æŸ¥

### å¦‚æœé–ƒçˆä»å­˜åœ¨

1. **å¢åŠ å®¹å¿åº¦**
```python
if tracked['age'] <= 5  # å¾ 3 å¢åŠ åˆ° 5
```

2. **æé«˜åŒ¹é…é–¾å€¼**
```python
if distance < 100:  # å¾ 80 å¢åŠ åˆ° 100
```

3. **é™ä½æª¢æ¸¬é »ç‡**
```python
frame_skip = 15  # æ¸›å°‘èª¤æª¢æ©Ÿæœƒ
```

### å¦‚æœç‰©é«”è¿½è¸ªå»¶é²

1. **é™ä½å®¹å¿åº¦**
```python
if tracked['age'] <= 2
```

2. **ç¸®çŸ­å­˜æ´»æ™‚é–“**
```python
max_age = 8
```

---

## ğŸ“š ç›¸é—œæŠ€è¡“æ–‡ä»¶

- **v1.2_stream_synctest.md** - ç¨‹å¼ç¢¼ç°¡åŒ–èˆ‡ Kalman Filter å¯¦ä½œ
- **stream_sync_optimization.md** - åˆå§‹å„ªåŒ–ç­–ç•¥
- **QUICK_FIX_GUIDE.md** - å¿«é€Ÿå•é¡Œæ’æŸ¥

---

## ğŸ’¡ æœªä¾†æ”¹é€²æ–¹å‘

### 1. è‡ªé©æ‡‰å®¹å¿åº¦
```python
# æ ¹æ“šç‰©é«”é€Ÿåº¦å‹•æ…‹èª¿æ•´
if velocity > threshold:
    display_tolerance = 2  # å¿«é€Ÿç§»å‹•ï¼šä½å®¹å¿
else:
    display_tolerance = 5  # æ…¢é€Ÿ/éœæ­¢ï¼šé«˜å®¹å¿
```

### 2. ä¿¡å¿ƒåº¦è¡°æ¸›
```python
# é¡¯ç¤ºæ™‚æ ¹æ“š age é™ä½é€æ˜åº¦
alpha = 1.0 - (tracked['age'] * 0.2)  # age=3 æ™‚ 40% é€æ˜
```

### 3. é æ¸¬è»Œè·¡å¯è¦–åŒ–
```python
# é¡¯ç¤º Kalman Filter é æ¸¬è·¯å¾‘
cv2.polylines(frame, predicted_trajectory, ...)
```

---

## âœ… ç¸½çµ

### é—œéµæˆå°±
1. âœ… **æ”¯æ´ FPS < 1**ï¼šå¯è¨­ç½® `frame_skip = 30/60`
2. âœ… **é–ƒçˆé¡¯è‘—é™ä½**ï¼š`age <= 3` å®¹å¿æ©Ÿåˆ¶
3. âœ… **åƒæ•¸åŒ–é…ç½®**ï¼š`max_age` å¯èª¿æ•´
4. âœ… **è¦–çª—å¤§å°æ§åˆ¶**ï¼š`WINDOW_NORMAL` æ¨¡å¼

### æŠ€è¡“äº®é»
- **é›™å±¤å®¹å¿æ©Ÿåˆ¶**ï¼šé¡¯ç¤ºå®¹å¿ï¼ˆ3 å¹€ï¼‰+ å­˜æ´»å®¹å¿ï¼ˆ15 å¹€ï¼‰
- **Kalman é æ¸¬å¡«è£œ**ï¼šåˆ©ç”¨é‹å‹•æ¨¡å‹é æ¸¬æš«æ™‚ä¸Ÿå¤±çš„ç‰©é«”ä½ç½®
- **å¹³æ»‘è¦–è¦ºé«”é©—**ï¼šå¾äºŒå…ƒé¡¯ç¤ºæ”¹ç‚ºæ¼¸é€²å¼å®¹å¿

### æ˜Ÿç´šè©•åƒ¹
- **ç©©å®šæ€§**: â­â­â­â­â­ï¼ˆ5/5ï¼‰
- **æ•ˆèƒ½**: â­â­â­â­ï¼ˆ4/5ï¼‰
- **å¯é…ç½®æ€§**: â­â­â­â­â­ï¼ˆ5/5ï¼‰
- **ä½¿ç”¨è€…é«”é©—**: â­â­â­â­â­ï¼ˆ5/5ï¼‰

---

**ç‰ˆæœ¬æ­·å²**:
- v1.0: åŸºç¤æª¢æ¸¬èˆ‡ç°¡å–®å¹³å‡
- v1.2: ç¨‹å¼ç¢¼ç°¡åŒ–ï¼ˆlist comprehensionsï¼‰
- v1.3: Kalman Filter å¯¦ä½œ
- **v1.2.2**: é–ƒçˆå„ªåŒ–èˆ‡ FPS èª¿æ•´ â­ (æœ¬å ±å‘Š)

---

*æœ¬å ±å‘Šç”± AI Assistant ç”Ÿæˆï¼Œè¨˜éŒ„æ–¼ 2025-11-05*
