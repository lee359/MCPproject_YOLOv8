# YOLOv8 + MCP + ESP32-CAM 實驗架構圖
**版本：v1.1.0**  
**日期：2025-11-06**  
**對應文件：v1.1_test_method.md**

---

## 🏗️ 實驗架構總覽圖

```
┌─────────────────────────────────────────────────────────────────────┐
│          YOLOv8 + MCP + ESP32-CAM 即時影像辨識系統實驗架構          │
│                           (v1.1)                                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                        🎯 核心研究問題                                │
├─────────────────────────────────────────────────────────────────────┤
│  Claude 透過 MCP 工具調用 YOLOv8，從 ESP32-CAM 即時串流辨識物體    │
│  有別於傳統手動上傳圖片的方式                                        │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
        ┌───────────────┐ ┌──────────────┐ ┌─────────────────┐
        │  實驗一：      │ │  實驗二：    │ │  實驗三：       │
        │  場景複雜度    │ │  工具效能    │ │  Kalman Filter  │
        │  測試          │ │  比較        │ │  追蹤評估       │
        └───────────────┘ └──────────────┘ └─────────────────┘
                │               │                    │
                └───────────────┴────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    ▼                       ▼
        ┌──────────────────────┐  ┌─────────────────────┐
        │  5 個核心評估指標     │  │  數據記錄與分析      │
        ├──────────────────────┤  ├─────────────────────┤
        │ • success            │  │ • CSV 自動儲存       │
        │ • detection_count    │  │ • 統計分析           │
        │ • detections         │  │ • 視覺化圖表         │
        │ • total_time         │  │ • Ground Truth 驗證  │
        │ • yolo_inference_time│  └─────────────────────┘
        └──────────────────────┘
```

---

## 📊 實驗一：場景複雜度測試架構

```
┌─────────────────────────────────────────────────────────────────┐
│             實驗一：場景複雜度測試（共 40 組數據）               │
└─────────────────────────────────────────────────────────────────┘

使用工具：detect_esp32_stream (use_kalman=True)
測試對象：貓、狗
控制變數：光照條件、相機位置、網路環境

                        ┌─────────────────┐
                        │  場景分類       │
                        └────────┬────────┘
                 ┌──────────────┼──────────────┐
                 ▼              ▼              ▼
        ┌────────────┐  ┌────────────┐  ┌────────────┐
        │  場景 A    │  │  場景 B    │  │  場景 C    │
        │  單一物體  │  │  雙物體    │  │  複雜場景  │
        └────────────┘  └────────────┘  └────────────┘
             │               │               │
    ┌────────┴────────┐      │               │
    ▼                 ▼      ▼               ▼
┌────────┐      ┌────────┐ ┌──────┐    ┌──────────┐
│單隻貓  │      │單隻狗  │ │貓+狗 │    │多隻動物  │
│×10次   │      │×10次   │ │×10次 │    │+背景物體 │
└────────┘      └────────┘ └──────┘    │×10次     │
                                        └──────────┘

每次記錄：
├─ detection_count: 偵測數量
├─ avg_confidence: 平均信心分數
├─ total_time: 端到端處理時間
├─ yolo_inference_time: YOLO 推論時間
└─ detected_classes: 偵測類別清單

預期發現：
• 場景 A 處理最快 (1.0-1.5秒)
• 場景 B 處理中等 (1.5-2.0秒)
• 場景 C 處理最慢 (2.0-2.5秒)
```

---

## 🔧 實驗二：MCP 工具效能比較架構

```
┌─────────────────────────────────────────────────────────────────┐
│          實驗二：MCP 工具效能比較（共 60 組數據）                │
└─────────────────────────────────────────────────────────────────┘

目標：比較兩種 MCP 工具在相同場景下的處理效能差異

                    ┌──────────────────┐
                    │   測試工具       │
                    └────────┬─────────┘
              ┌─────────────┴─────────────┐
              ▼                           ▼
    ┌────────────────────┐      ┌────────────────────┐
    │ detect_esp32_stream│      │detect_stream_frame │
    │    (完整版)         │      │    _simple         │
    │                    │      │   (簡化版)         │
    ├────────────────────┤      ├────────────────────┤
    │✓ Kalman Filter     │      │✗ 無 Kalman         │
    │✓ 多幀處理          │      │✓ 單幀處理          │
    │✓ 返回 base64 圖像  │      │✗ 不返回圖像        │
    │✓ 物體追蹤          │      │✓ 快速辨識          │
    └────────────────────┘      └────────────────────┘
              │                           │
              └─────────┬─────────────────┘
                        ▼
            ┌───────────────────────┐
            │  相同測試場景          │
            ├───────────────────────┤
            │ • 場景 A (貓×10, 狗×10)│
            │ • 場景 B (貓+狗×10)    │
            │ • 場景 C (複雜×10)     │
            └───────────────────────┘
                        │
                        ▼
            ┌───────────────────────┐
            │  效能比較指標          │
            ├───────────────────────┤
            │ • total_time 差異      │
            │ • yolo_inference_time  │
            │ • mcp_overhead         │
            │ • fps (每秒處理幀數)   │
            └───────────────────────┘

預期結果：
┌────────────────────────┬─────────────┬──────────────┐
│       工具             │ total_time  │     FPS      │
├────────────────────────┼─────────────┼──────────────┤
│ detect_esp32_stream    │ 1.5-2.0 秒  │  0.5-0.7     │
│ detect_stream_..simple │ 0.5-1.0 秒  │  1.0-2.0     │
└────────────────────────┴─────────────┴──────────────┘
```

---

## 🎯 實驗三：Kalman Filter 追蹤效能評估架構

```
┌─────────────────────────────────────────────────────────────────┐
│        實驗三：Kalman Filter 追蹤效能評估（共 40 組數據）        │
└─────────────────────────────────────────────────────────────────┘

使用工具：detect_esp32_stream
目標：評估 Kalman Filter 對追蹤穩定性與處理時間的影響

                    ┌──────────────────┐
                    │  配置設定        │
                    └────────┬─────────┘
              ┌─────────────┴─────────────┐
              ▼                           ▼
    ┌────────────────────┐      ┌────────────────────┐
    │  use_kalman=True   │      │  use_kalman=False  │
    │   (啟用追蹤)        │      │   (停用追蹤)        │
    └────────────────────┘      └────────────────────┘
              │                           │
              └─────────┬─────────────────┘
                        ▼
            ┌───────────────────────┐
            │  測試場景              │
            ├───────────────────────┤
            │ 場景 A：單一物體       │
            │  ├─ 啟用 Kalman ×10   │
            │  └─ 停用 Kalman ×10   │
            │                       │
            │ 場景 B：雙物體         │
            │  ├─ 啟用 Kalman ×10   │
            │  └─ 停用 Kalman ×10   │
            └───────────────────────┘
                        │
                        ▼
            ┌───────────────────────┐
            │  評估指標              │
            ├───────────────────────┤
            │ • 追蹤穩定性           │
            │   (邊界框變異係數)     │
            │ • 時間開銷             │
            │   (total_time 差異)    │
            │ • 物體追蹤連續性       │
            └───────────────────────┘

預期發現：
┌─────────────┬──────────────┬─────────────┬─────────────┐
│   配置      │  total_time  │ 邊界框穩定性│  追蹤連續性 │
├─────────────┼──────────────┼─────────────┼─────────────┤
│ Kalman ON   │  1.8 秒      │   ⭐⭐⭐⭐⭐   │    ✓✓✓      │
│ Kalman OFF  │  1.5 秒      │   ⭐⭐⭐       │    ✓        │
└─────────────┴──────────────┴─────────────┴─────────────┘

結論：Kalman Filter 增加 ~20% 處理時間，但顯著提升追蹤穩定性
```

---

## 💾 數據記錄系統架構

```
┌─────────────────────────────────────────────────────────────────┐
│            MCPExperimentLogger_v1_1 數據記錄系統                 │
└─────────────────────────────────────────────────────────────────┘

實驗執行
    │
    ├─► 每次測試調用 MCP 工具
    │        │
    │        ▼
    │   ┌─────────────────────┐
    │   │  MCP 工具返回 JSON  │
    │   ├─────────────────────┤
    │   │ • timestamp         │
    │   │ • success           │
    │   │ • detection_count   │
    │   │ • detections[]      │
    │   │ • total_time        │
    │   │ • yolo_inference... │
    │   └─────────────────────┘
    │        │
    ├────────┼─► log_trial() 記錄數據
    │        │
    │        ▼
    │   ┌─────────────────────┐
    │   │  計算衍生指標       │
    │   ├─────────────────────┤
    │   │ • avg_confidence    │
    │   │ • mcp_overhead      │
    │   │ • fps               │
    │   │ • yolo_percentage   │
    │   └─────────────────────┘
    │        │
    │        ▼
    │   ┌─────────────────────┐
    │   │  儲存到記憶體       │
    │   │  (self.data[])      │
    │   └─────────────────────┘
    │
    └─► 每 10 次或實驗結束
             │
             ▼
        ┌──────────────────────────┐
        │  save_to_csv()           │
        │  ├─ 匯出 CSV 檔案        │
        │  └─ 保存完整數據         │
        └──────────────────────────┘
             │
             ▼
        ┌──────────────────────────┐
        │  get_summary_statistics()│
        │  ├─ 整體統計             │
        │  ├─ 按場景分組           │
        │  ├─ 按工具分組           │
        │  └─ Kalman 影響分析      │
        └──────────────────────────┘
             │
             ▼
        ┌──────────────────────────┐
        │  plot_performance_...()  │
        │  ├─ 場景 vs 時間         │
        │  ├─ 工具比較圖           │
        │  ├─ 信心分數分佈         │
        │  └─ FPS 分佈             │
        └──────────────────────────┘
```

---

## 📊 5 個核心指標架構

```
┌─────────────────────────────────────────────────────────────────┐
│                    核心評估指標體系                              │
└─────────────────────────────────────────────────────────────────┘

                    ┌──────────────────┐
                    │   MCP 返回數據   │
                    └────────┬─────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ 系統穩定性   │    │ 辨識能力     │    │ 效能指標     │
├──────────────┤    ├──────────────┤    ├──────────────┤
│ • success    │    │• detection_  │    │• total_time  │
│   (布林值)   │    │  count       │    │  (秒)        │
│              │    │  (整數)      │    │              │
│用途：        │    │              │    │• yolo_       │
│計算成功率    │    │• detections[]│    │  inference_  │
│              │    │  (陣列)      │    │  time (秒)   │
│              │    │              │    │              │
│              │    │用途：        │    │用途：        │
│              │    │準確率計算    │    │即時性評估    │
│              │    │信心分數分析  │    │系統瓶頸分析  │
└──────────────┘    └──────────────┘    └──────────────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             ▼
                    ┌──────────────────┐
                    │  衍生指標計算    │
                    ├──────────────────┤
                    │ • 成功率 (%)     │
                    │ • 平均信心分數   │
                    │ • MCP 傳輸開銷   │
                    │ • FPS (幀/秒)    │
                    │ • YOLO 佔比 (%)  │
                    └──────────────────┘
```

---

## 🔄 完整實驗流程架構

```
┌─────────────────────────────────────────────────────────────────┐
│                      實驗執行流程圖                              │
└─────────────────────────────────────────────────────────────────┘

階段一：環境準備 (15 分鐘)
    │
    ├─► 硬體設置
    │   ├─ 固定 ESP32-CAM
    │   ├─ 驗證串流 URL
    │   └─ check_stream_health()
    │
    ├─► 軟體配置
    │   ├─ 啟動 MCP 伺服器
    │   ├─ 初始化 Logger
    │   └─ 連接 Claude Desktop
    │
    └─► 校準測試 (3次)
        └─ 確認 success=True
             │
             ▼
階段二：實驗一執行 (40 組)
    │
    ├─► 場景 A (20 組)
    │   ├─ 單隻貓 ×10
    │   └─ 單隻狗 ×10
    │
    ├─► 場景 B (10 組)
    │   └─ 貓+狗 ×10
    │
    └─► 場景 C (10 組)
        └─ 複雜場景 ×10
             │
             ▼
階段三：實驗二執行 (30 組)
    │
    └─► 使用 detect_stream_frame_simple
        ├─ 場景 A ×10
        ├─ 場景 B ×10
        └─ 場景 C ×10
             │
             ▼
階段四：實驗三執行 (40 組)
    │
    ├─► 場景 A
    │   ├─ Kalman ON ×10
    │   └─ Kalman OFF ×10
    │
    └─► 場景 B
        ├─ Kalman ON ×10
        └─ Kalman OFF ×10
             │
             ▼
階段五：數據處理
    │
    ├─► save_to_csv()
    ├─► get_summary_statistics()
    ├─► plot_performance_comparison()
    ├─► 人工驗證 Ground Truth
    └─► 撰寫實驗報告

總計：110-120 組實驗數據
```

---

## 🎯 預期成果架構

```
┌─────────────────────────────────────────────────────────────────┐
│                        預期成果輸出                              │
└─────────────────────────────────────────────────────────────────┘

量化成果
    │
    ├─► CSV 數據檔案 (110-120 組)
    │   └─ timestamp, scene_type, mcp_tool, success,
    │      detection_count, total_time, yolo_time, ...
    │
    ├─► 統計分析報告
    │   ├─ 平均成功率: 95%+
    │   ├─ 平均處理時間: 1-2 秒
    │   ├─ 平均 FPS: 0.5-1.0
    │   └─ 平均信心分數: 0.75-0.90
    │
    └─► 效能基準數據
        ├─ detect_esp32_stream: 1.5-2.0 秒
        ├─ detect_stream_..simple: 0.5-1.0 秒
        └─ YOLOv8 推論: 0.2-0.5 秒

視覺化輸出
    │
    ├─► 圖表 1: 場景複雜度 vs 處理時間 (柱狀圖)
    ├─► 圖表 2: 工具效能比較 (箱型圖)
    ├─► 圖表 3: 時間分解 (堆疊圖)
    ├─► 圖表 4: 信心分數分佈 (直方圖)
    └─► 圖表 5: FPS 趨勢 (折線圖)

研究發現
    │
    ├─► 簡化版工具處理速度提升 50-100%
    ├─► Kalman Filter 時間開銷 ~20%
    ├─► YOLO 推論佔總時間 40-60%
    └─► 系統滿足即時監控需求 (FPS ≥ 1)
```

---

## 📈 系統運作流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                   MCP + YOLOv8 系統運作流程                      │
└─────────────────────────────────────────────────────────────────┘

使用者
  │
  │ 發出指令：「偵測 ESP32-CAM 的畫面」
  ▼
┌──────────────────┐
│  Claude Desktop  │
│  (MCP 客戶端)    │
└────────┬─────────┘
         │
         │ 調用 MCP 工具
         ▼
┌──────────────────────────┐
│  FastMCP 伺服器          │
│  (mcpclient.py)          │
│  ┌────────────────────┐  │
│  │ detect_esp32_stream│  │
│  │ 或                 │  │
│  │ detect_stream_...  │  │
│  │ _frame_simple      │  │
│  └────────────────────┘  │
└────────┬─────────────────┘
         │
         │ HTTP GET
         ▼
┌──────────────────┐
│   ESP32-CAM      │
│   串流伺服器     │
│   192.168.0.104  │
└────────┬─────────┘
         │
         │ 返回影像幀
         ▼
┌──────────────────┐
│   OpenCV         │
│   cv2.VideoCapture│
└────────┬─────────┘
         │
         │ 影像預處理
         ▼
┌──────────────────┐
│   YOLOv8 模型    │
│   (best.pt)      │
│   + GPU 加速     │
└────────┬─────────┘
         │
         │ 推論結果 (detections)
         ▼
┌──────────────────┐
│  Kalman Filter   │
│  (選用)          │
│  追蹤平滑化      │
└────────┬─────────┘
         │
         │ 返回 JSON 結果
         ▼
┌──────────────────┐
│  Claude Desktop  │
│  呈現結果給使用者│
└──────────────────┘
         │
         ▼
     使用者看到：
     「偵測到 1 隻貓，信心分數 0.85」
```

---

## 📋 MCP 工具參數架構

```
┌─────────────────────────────────────────────────────────────────┐
│               detect_esp32_stream 參數架構                       │
└─────────────────────────────────────────────────────────────────┘

detect_esp32_stream(
    ├─ url: str = None
    │   └─ 串流 URL，預設：http://192.168.0.104:81/stream
    │
    ├─ imgsz: int = 640
    │   └─ YOLO 輸入圖像大小
    │
    ├─ conf: float = 0.25
    │   └─ 信心閾值
    │
    ├─ frame_skip: int = 3
    │   └─ 跳幀數（每 N 幀處理一次）
    │
    ├─ max_age: int = 10
    │   └─ 物體追蹤最大年齡
    │
    ├─ display_tolerance: int = 2
    │   └─ 顯示容忍度
    │
    └─ use_kalman: bool = True
        └─ 是否啟用 Kalman Filter 追蹤
) -> dict


┌─────────────────────────────────────────────────────────────────┐
│            detect_stream_frame_simple 參數架構                   │
└─────────────────────────────────────────────────────────────────┘

detect_stream_frame_simple(
    ├─ stream_url: str
    │   └─ 串流 URL（必填）
    │
    ├─ imgsz: int = 416
    │   └─ YOLO 輸入圖像大小（較小以提升速度）
    │
    └─ conf: float = 0.3
        └─ 信心閾值
) -> dict
```

---

## 🔗 相關文件索引

```
MCPproject-YOLOv8/
├─ ai_docs/
│  ├─ v1.1_test_method.md ..................... 實驗方法詳細文件
│  ├─ v1.1.0_test_method_struc.md ............. 本架構圖文件
│  ├─ v1.0_test_method.md ..................... 舊版實驗方法
│  ├─ mcp_implementation_technical_report.md .. MCP 技術報告
│  ├─ mcp_tools_usage_guide.md ................ MCP 工具使用指南
│  └─ v1.1_workflow.md ........................ 工作流程說明
│
├─ mcpclient.py ............................... MCP 伺服器主程式
├─ 實驗方法章節.md ............................ 報告用精簡版
└─ best.pt .................................... YOLOv8 訓練模型
```

---

## 📝 版本更新記錄

- **v1.1.0** (2025-11-06)：初版架構圖，對應 v1.1_test_method.md
  - 包含三個實驗的完整架構
  - 5 個核心指標體系
  - 數據記錄系統流程
  - 系統運作流程圖

---

**本文件提供視覺化的實驗架構，幫助理解 v1.1_test_method.md 的實驗設計**
