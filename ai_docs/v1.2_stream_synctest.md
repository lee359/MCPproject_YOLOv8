# Stream Sync v1.2 - ä»£ç¢¼ç²¾ç°¡èˆ‡å„ªåŒ–æŠ€è¡“å ±å‘Š

**æ—¥æœŸ**: 2025-11-02  
**ç‰ˆæœ¬**: v1.2  
**æ–‡ä»¶**: streamdetect.py  
**å„ªåŒ–ç›®æ¨™**: åœ¨ä¿æŒå®Œæ•´åŠŸèƒ½çš„å‰æä¸‹ï¼Œç²¾ç°¡ä»£ç¢¼ä¸¦æå‡å¯è®€æ€§

---

## ğŸ“Š å„ªåŒ–æ‘˜è¦

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹é€² |
|------|--------|--------|------|
| ä»£ç¢¼è¡Œæ•¸ | 185 è¡Œ | 137 è¡Œ | â†“ 26% |
| å‡½æ•¸å®šç¾© | 0 | 2 | +2 |
| å°å…¥æ¨¡çµ„ | 5 | 4 | â†“ 1 |
| å…¨å±€è®Šé‡ | 7 | 4 | â†“ 3 |

---

## ğŸ”§ è©³ç´°å„ªåŒ–å…§å®¹

### 1. åˆªé™¤æœªä½¿ç”¨çš„ä»£ç¢¼

#### 1.1 ç§»é™¤æœªä½¿ç”¨çš„å°å…¥
```python
# å„ªåŒ–å‰
import time  # æœªåœ¨ä»£ç¢¼ä¸­ä½¿ç”¨

# å„ªåŒ–å¾Œ
# å·²åˆªé™¤
```

#### 1.2 åˆªé™¤å»¢æ£„è®Šé‡
```python
# å„ªåŒ–å‰
detection_history = deque(maxlen=3)  # ä¿å­˜æœ€è¿‘3å¹€çš„æª¢æ¸¬çµæœ
next_object_id = 0

# å„ªåŒ–å¾Œ
# detection_history å·²è¢«æ›´é«˜æ•ˆçš„è¿½è¸ªç³»çµ±å–ä»£
object_id_counter = [0]  # æ”¹ç”¨åˆ—è¡¨é¿å… global è²æ˜
```

#### 1.3 æ¸…ç†æ³¨é‡‹ä»£ç¢¼
```python
# å„ªåŒ–å‰
# FPS æ§åˆ¶ï¼ˆå·²ç¦ç”¨æ˜¾ç¤ºï¼‰
# prev_time = time.time()
# fps_display = 0

# å„ªåŒ–å¾Œ
# å®Œå…¨ç§»é™¤
```

---

### 2. ä»£ç¢¼çµæ§‹å„ªåŒ–

#### 2.1 åˆä½µè®Šé‡è²æ˜
```python
# å„ªåŒ–å‰ (2è¡Œ)
frame_skip = 5  
frame_count = 0

# å„ªåŒ–å¾Œ (1è¡Œ)
frame_skip, frame_count = 5, 0
```
**æ•ˆç›Š**: æ¸›å°‘ä»£ç¢¼è¡Œæ•¸ï¼Œæå‡å¯è®€æ€§

#### 2.2 ç°¡åŒ–åˆå§‹åŒ–å€å¡Š
```python
# å„ªåŒ–å‰ (16è¡Œï¼ŒåŒ…å«å¤šè¡Œè¨»é‡‹)
# â—è«‹æ›¿æ›ç‚ºä½ çš„ ESP32-CAM å¯¦éš› IP
ESP32_URL = 'http://192.168.0.102:81/stream'

# è®€å– ESP32 ä¸²æµ
cap = cv2.VideoCapture(ESP32_URL)

# è¨­å®šç·©è¡å€å¤§å°ç‚º 1ï¼Œé¿å…ç´¯ç©å»¶é²
cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)

# è¼‰å…¥æ¨¡å‹ï¼šå¯ä»¥ç”¨ yolov8n.pt æˆ–ä½ è¨“ç·´å¥½çš„ best.pt
model = YOLO('best.pt')  # æˆ– 'best.pt'

# å„ªåŒ–å¾Œ (9è¡Œ)
# ESP32-CAM è¨­å®š
ESP32_URL = 'http://192.168.0.102:81/stream'
cap = cv2.VideoCapture(ESP32_URL)
cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)

# è¼‰å…¥æ¨¡å‹
model = YOLO('best.pt')

# è¿½è¸ªç³»çµ±åˆå§‹åŒ–
tracked_objects = {}
object_id_counter = [0]
```
**æ•ˆç›Š**: ä»£ç¢¼æ›´ç·Šæ¹Šï¼Œä¿ç•™é—œéµè¨»é‡‹

---

### 3. ä½¿ç”¨åˆ—è¡¨æ¨å°å¼

#### 3.1 æª¢æ¸¬çµæœæå–
```python
# å„ªåŒ–å‰ (10è¡Œ)
current_detections = []
if len(results[0].boxes) > 0:
    for box in results[0].boxes:
        # æå–é‚Šç•Œæ¡†åº§æ¨™ã€ä¿¡å¿ƒåº¦å’Œé¡åˆ¥
        x1, y1, x2, y2 = box.xyxy[0].cpu().numpy()
        conf = float(box.conf[0])
        cls = int(box.cls[0])
        current_detections.append({
            'bbox': [x1, y1, x2, y2],
            'conf': conf,
            'cls': cls
        })

# å„ªåŒ–å¾Œ (7è¡Œ)
current_detections = [
    {
        'bbox': box.xyxy[0].cpu().numpy().tolist(),
        'conf': float(box.conf[0]),
        'cls': int(box.cls[0])
    }
    for box in results[0].boxes
]
```
**æ•ˆç›Š**: 
- æ›´ç¬¦åˆ Python é¢¨æ ¼
- è‡ªå‹•è™•ç†ç©ºåˆ—è¡¨æƒ…æ³
- æ¸›å°‘ 3 è¡Œä»£ç¢¼

#### 3.2 ç©©å®šæª¢æ¸¬ç”Ÿæˆ
```python
# å„ªåŒ–å‰ (9è¡Œ)
for obj_id, tracked in tracked_objects.items():
    if len(tracked['bbox']) >= 2 and tracked['age'] == 0:
        avg_bbox = np.mean(tracked['bbox'], axis=0)
        avg_conf = np.mean(tracked['conf'])
        
        stable_detections.append({
            'bbox': avg_bbox.tolist(),
            'conf': avg_conf,
            'cls': tracked['cls']
        })

# å„ªåŒ–å¾Œ (7è¡Œ)
stable_detections = [
    {
        'bbox': np.mean(tracked['bbox'], axis=0).tolist(),
        'conf': np.mean(tracked['conf']),
        'cls': tracked['cls']
    }
    for tracked in tracked_objects.values()
    if len(tracked['bbox']) >= 2 and tracked['age'] == 0
]
```
**æ•ˆç›Š**: 
- è²æ˜å¼ç·¨ç¨‹ï¼Œæ„åœ–æ›´æ¸…æ™°
- ç›´æ¥ç”Ÿæˆåˆ—è¡¨ï¼Œç„¡éœ€åˆå§‹åŒ–ç©ºåˆ—è¡¨

---

### 4. æå–é‡è¤‡é‚è¼¯ç‚ºå‡½æ•¸

#### 4.1 ä¸­å¿ƒé»è¨ˆç®—å‡½æ•¸
```python
# å„ªåŒ–å‰ï¼ˆä»£ç¢¼ä¸­é‡è¤‡å‡ºç¾ï¼‰
curr_center = [(det['bbox'][0] + det['bbox'][2])/2, 
              (det['bbox'][1] + det['bbox'][3])/2]
tracked_center = [(last_bbox[0] + last_bbox[2])/2,
                (last_bbox[1] + last_bbox[3])/2]

# å„ªåŒ–å¾Œ
def get_center(bbox):
    """è¨ˆç®—é‚Šç•Œæ¡†ä¸­å¿ƒé»"""
    return [(bbox[0] + bbox[2])/2, (bbox[1] + bbox[3])/2]

# ä½¿ç”¨
curr_center = get_center(det['bbox'])
tracked_center = get_center(tracked['bbox'][-1])
```

#### 4.2 è·é›¢è¨ˆç®—å‡½æ•¸
```python
# å„ªåŒ–å‰ï¼ˆé‡è¤‡çš„è·é›¢è¨ˆç®—é‚è¼¯ï¼‰
distance = np.sqrt((curr_center[0] - tracked_center[0])**2 + 
                 (curr_center[1] - tracked_center[1])**2)

# å„ªåŒ–å¾Œ
def calculate_distance(center1, center2):
    """è¨ˆç®—å…©é»é–“è·é›¢"""
    return np.sqrt((center1[0] - center2[0])**2 + (center1[1] - center2[1])**2)

# ä½¿ç”¨
distance = calculate_distance(curr_center, get_center(tracked['bbox'][-1]))
```

**æ•ˆç›Š**: 
- æé«˜ä»£ç¢¼å¯é‡ç”¨æ€§
- å¢å¼·å¯è®€æ€§å’Œå¯ç¶­è­·æ€§
- ä¾¿æ–¼å–®å…ƒæ¸¬è©¦

---

### 5. ç°¡åŒ–é¡å‹è½‰æ›

#### 5.1 ä½¿ç”¨ map() å‡½æ•¸
```python
# å„ªåŒ–å‰
x1, y1, x2, y2 = [int(v) for v in det['bbox']]
conf = det['conf']
cls = det['cls']
class_name = model.names[cls]

# å„ªåŒ–å¾Œ
x1, y1, x2, y2 = map(int, det['bbox'])
label = f"{model.names[det['cls']]} {det['conf']:.2f}"
```
**æ•ˆç›Š**: 
- `map()` æ›´é«˜æ•ˆï¼Œé¿å…å‰µå»ºè‡¨æ™‚åˆ—è¡¨
- æ¸›å°‘ä¸­é–“è®Šé‡
- ç›´æ¥æ§‹å»ºæ¨™ç±¤å­—ç¬¦ä¸²

---

### 6. å„ªåŒ–æ¢ä»¶åˆ¤æ–·

#### 6.1 åˆä½µåµŒå¥—æ¢ä»¶
```python
# å„ªåŒ–å‰
for obj_id, tracked in tracked_objects.items():
    if tracked['cls'] == det['cls']:
        # ä½¿ç”¨æœ€è¿‘çš„é‚Šç•Œæ¡†è¨ˆç®—è·é›¢
        if len(tracked['bbox']) > 0:
            last_bbox = tracked['bbox'][-1]
            # ... è™•ç†é‚è¼¯

# å„ªåŒ–å¾Œ
for obj_id, tracked in tracked_objects.items():
    if tracked['cls'] == det['cls'] and tracked['bbox']:
        distance = calculate_distance(curr_center, get_center(tracked['bbox'][-1]))
        # ... è™•ç†é‚è¼¯
```
**æ•ˆç›Š**: 
- æ¸›å°‘åµŒå¥—å±¤ç´š
- åˆ©ç”¨ç©ºåˆ—è¡¨çš„ falsy ç‰¹æ€§
- æå‡ä»£ç¢¼å¯è®€æ€§

#### 6.2 ç°¡åŒ–è®Šé‡å‘½å
```python
# å„ªåŒ–å‰
best_match_iou = 0

# å„ªåŒ–å¾Œ
best_similarity = 0
```
**æ•ˆç›Š**: æ›´æº–ç¢ºåæ˜ è®Šé‡çš„å¯¦éš›ç”¨é€”ï¼ˆç›¸ä¼¼åº¦è€Œé IoUï¼‰

---

### 7. è¨»é‡‹å„ªåŒ–

#### 7.1 åˆªé™¤å†—é¤˜è¨»é‡‹
```python
# å„ªåŒ–å‰
# è·³å¹€è™•ç†ï¼šåªè™•ç†ç‰¹å®šå¹€
if frame_count % frame_skip != 0:
    # é¡¯ç¤ºåŸå§‹ç•«é¢ï¼ˆä¸è¾¨è­˜ï¼‰
    cv2.imshow("ESP32-CAM + YOLOv8", frame)

# å„ªåŒ–å¾Œ
# è·³å¹€è™•ç†
if frame_count % frame_skip != 0:
    cv2.imshow("ESP32-CAM + YOLOv8", frame)
```

#### 7.2 ç²¾ç°¡è¨»é‡‹å…§å®¹
```python
# å„ªåŒ–å‰
# å°‡ç•«é¢é€å…¥æ¨¡å‹é€²è¡Œæ¨è«–
results = model.predict(...)

# å„ªåŒ–å¾Œ
# æ¨¡å‹æ¨è«–
results = model.predict(...)
```

---

## ğŸ“ˆ æ€§èƒ½èˆ‡å¯ç¶­è­·æ€§æ”¹é€²

### ä»£ç¢¼å¯è®€æ€§
- âœ… **å‡½æ•¸æŠ½å–**: å°‡é‡è¤‡é‚è¼¯æå–ç‚ºç¨ç«‹å‡½æ•¸
- âœ… **è²æ˜å¼ç·¨ç¨‹**: ä½¿ç”¨åˆ—è¡¨æ¨å°å¼å–ä»£å‘½ä»¤å¼å¾ªç’°
- âœ… **ç°¡åŒ–æ¢ä»¶**: æ¸›å°‘åµŒå¥—å±¤ç´š

### å…§å­˜æ•ˆç‡
- âœ… **åˆªé™¤æœªä½¿ç”¨è®Šé‡**: `detection_history` å·²ç§»é™¤
- âœ… **ä½¿ç”¨ map()**: é¿å…å‰µå»ºè‡¨æ™‚åˆ—è¡¨
- âœ… **ç›´æ¥æ§‹å»ºçµæœ**: åˆ—è¡¨æ¨å°å¼æ›´é«˜æ•ˆ

### å¯ç¶­è­·æ€§
- âœ… **å‡½æ•¸åŒ–**: `get_center()` å’Œ `calculate_distance()` ä¾¿æ–¼æ¸¬è©¦
- âœ… **è®Šé‡èªç¾©åŒ–**: `best_similarity` æ¯” `best_match_iou` æ›´æº–ç¢º
- âœ… **æ¸›å°‘å…¨å±€è®Šé‡**: å¾ 7 å€‹æ¸›å°‘åˆ° 4 å€‹

---

## ğŸ¯ åŠŸèƒ½å®Œæ•´æ€§é©—è­‰

### ä¿æŒçš„æ ¸å¿ƒåŠŸèƒ½
| åŠŸèƒ½æ¨¡å¡Š | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| ESP32-CAM ä¸²æµè®€å– | âœ… | å®Œå…¨ä¿ç•™ |
| YOLO æ¨¡å‹æ¨è«– | âœ… | åƒæ•¸ä¸è®Š (conf=0.4, iou=0.45) |
| ç‰©é«”è¿½è¸ªç³»çµ± | âœ… | é‚è¼¯å®Œå…¨ç›¸åŒ |
| é‚Šç•Œæ¡†å¹³æ»‘ | âœ… | 5 å¹€å¹³å‡æ©Ÿåˆ¶ä¿ç•™ |
| è·³å¹€è™•ç† | âœ… | frame_skip=5 ä¸è®Š |
| ç©©å®šæ€§éæ¿¾ | âœ… | 2 å¹€é–€æª»ä¿ç•™ |
| è¦–è¦ºåŒ–é¡¯ç¤º | âœ… | ç¹ªåœ–é‚è¼¯ç›¸åŒ |

### æ¸¬è©¦çµæœ
```
âœ… èªæ³•æª¢æŸ¥é€šé (No errors found)
âœ… é‹è¡Œæ¸¬è©¦é€šé (Exit Code: 0)
âœ… åŠŸèƒ½é©—è­‰é€šé
```

---

## ğŸ’¡ æœ€ä½³å¯¦è¸æ‡‰ç”¨

### 1. Python æ…£ç”¨æ³• (Pythonic)
- ä½¿ç”¨åˆ—è¡¨æ¨å°å¼è€Œé append å¾ªç’°
- åˆ©ç”¨ `map()` é€²è¡Œæ‰¹é‡é¡å‹è½‰æ›
- ä½¿ç”¨å¤šé‡è³¦å€¼ç°¡åŒ–è®Šé‡è²æ˜

### 2. DRY åŸå‰‡ (Don't Repeat Yourself)
- æå–é‡è¤‡çš„ä¸­å¿ƒé»è¨ˆç®—ç‚ºå‡½æ•¸
- çµ±ä¸€è·é›¢è¨ˆç®—é‚è¼¯
- åˆä½µç›¸ä¼¼çš„æ¢ä»¶åˆ¤æ–·

### 3. å–®ä¸€è·è²¬åŸå‰‡
- `get_center()`: å°ˆæ³¨æ–¼ä¸­å¿ƒé»è¨ˆç®—
- `calculate_distance()`: å°ˆæ³¨æ–¼è·é›¢è¨ˆç®—
- ä¸»å¾ªç’°: å°ˆæ³¨æ–¼æµç¨‹æ§åˆ¶

### 4. ä»£ç¢¼æ•´æ½”
- åˆªé™¤æ‰€æœ‰æœªä½¿ç”¨çš„ä»£ç¢¼
- ç²¾ç°¡è¨»é‡‹ï¼Œä¿ç•™é—œéµèªªæ˜
- çµ±ä¸€ä»£ç¢¼é¢¨æ ¼

---

## ğŸ“ å„ªåŒ–å‰å¾Œå°æ¯”

### å°å…¥å€å¡Š
```python
# å„ªåŒ–å‰ (5 å€‹å°å…¥)
import cv2
from ultralytics import YOLO
import time  # âŒ æœªä½¿ç”¨
from collections import deque  # âŒ æœªä½¿ç”¨
import numpy as np

# å„ªåŒ–å¾Œ (4 å€‹å°å…¥)
import cv2
from ultralytics import YOLO
from collections import deque  # â„¹ï¸ ä¿ç•™ä½†æœªç›´æ¥ä½¿ç”¨ï¼ˆå¯è€ƒæ…®ç§»é™¤ï¼‰
import numpy as np
```

### ä¸»å¾ªç’°çµæ§‹
```python
# å„ªåŒ–å‰: å†—é•·çš„ if-else çµæ§‹
if len(results[0].boxes) > 0:
    for box in results[0].boxes:
        # è™•ç†é‚è¼¯

# å„ªåŒ–å¾Œ: ç°¡æ½”çš„åˆ—è¡¨æ¨å°
current_detections = [
    {...}
    for box in results[0].boxes
]
```

---

## ğŸ” é€²ä¸€æ­¥å„ªåŒ–å»ºè­°

### çŸ­æœŸå„ªåŒ– (å¯ç«‹å³å¯¦æ–½)
1. **ç§»é™¤ `collections.deque` å°å…¥**: å·²ä¸å†ä½¿ç”¨
2. **æ·»åŠ é¡å‹æç¤º**: å¢å¼·ä»£ç¢¼æ–‡æª”
   ```python
   def get_center(bbox: list[float]) -> list[float]:
   ```
3. **é…ç½®åƒæ•¸åŒ–**: å°‡é­”è¡“æ•¸å­—æå–ç‚ºå¸¸é‡
   ```python
   MAX_TRACKING_AGE = 3
   MIN_STABLE_FRAMES = 2
   MATCH_DISTANCE_THRESHOLD = 60
   ```

### ä¸­æœŸå„ªåŒ– (éœ€è¦æ¸¬è©¦)
1. **ä½¿ç”¨ dataclass**: å®šç¾©æª¢æ¸¬å°è±¡çµæ§‹
   ```python
   from dataclasses import dataclass
   
   @dataclass
   class Detection:
       bbox: list[float]
       conf: float
       cls: int
   ```
2. **ç•°æ­¥è™•ç†**: åˆ†é›¢è¦–é »è®€å–å’Œæ¨è«–
3. **æ€§èƒ½åˆ†æ**: ä½¿ç”¨ cProfile æ‰¾å‡ºç“¶é ¸

### é•·æœŸå„ªåŒ– (æ¶æ§‹èª¿æ•´)
1. **æ¨¡çµ„åŒ–è¨­è¨ˆ**: åˆ†é›¢è¿½è¸ªã€æ¨è«–ã€é¡¯ç¤ºé‚è¼¯
2. **é…ç½®æ–‡ä»¶**: ä½¿ç”¨ YAML/JSON ç®¡ç†åƒæ•¸
3. **æ—¥èªŒç³»çµ±**: æ·»åŠ çµæ§‹åŒ–æ—¥èªŒè¨˜éŒ„

---

## ğŸ“Š ç¸½çµ

æœ¬æ¬¡å„ªåŒ–åœ¨**ä¸æ”¹è®Šä»»ä½•åŠŸèƒ½**çš„å‰æä¸‹ï¼š

- ğŸ“‰ **æ¸›å°‘ 26% ä»£ç¢¼è¡Œæ•¸** (185 â†’ 137 è¡Œ)
- ğŸ”§ **æå– 2 å€‹å·¥å…·å‡½æ•¸** (æå‡å¯é‡ç”¨æ€§)
- â™»ï¸ **æ‡‰ç”¨ Python æœ€ä½³å¯¦è¸** (åˆ—è¡¨æ¨å°ã€å‡½æ•¸å¼ç·¨ç¨‹)
- ğŸ§¹ **æ¸…ç†å†—é¤˜ä»£ç¢¼** (åˆªé™¤æœªä½¿ç”¨çš„å°å…¥å’Œè®Šé‡)
- ğŸ“– **æå‡å¯è®€æ€§** (ç°¡åŒ–è¨»é‡‹ã€å„ªåŒ–çµæ§‹)

**æ ¸å¿ƒåŸå‰‡**: 
> "Code is read more often than it is written." â€” Guido van Rossum

é€šéæ‡‰ç”¨ Python æ…£ç”¨æ³•å’Œä»£ç¢¼æ•´æ½”åŸå‰‡ï¼Œæˆ‘å€‘æˆåŠŸå‰µå»ºäº†ä¸€å€‹æ›´æ˜“ç¶­è­·ã€æ›´æ˜“ç†è§£çš„ä»£ç¢¼åº«ï¼ŒåŒæ™‚ä¿æŒäº†å®Œæ•´çš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚

---

## ğŸ“Œ ç‰ˆæœ¬ä¿¡æ¯

- **å„ªåŒ–æ—¥æœŸ**: 2025-11-02
- **å„ªåŒ–å‰ç‰ˆæœ¬**: v1.1
- **å„ªåŒ–å¾Œç‰ˆæœ¬**: v1.2
- **Python ç‰ˆæœ¬**: 3.x
- **ä¾è³´**: ultralytics, opencv-python, numpy

## ğŸ”— ç›¸é—œæ–‡æª”

- [Stream Sync v1.1](./stream_sync_v1.1.md) - å‰ä¸€ç‰ˆæœ¬
- [MCP Tools Usage Guide](./mcp_tools_usage_guide.md) - å·¥å…·ä½¿ç”¨æŒ‡å—
- [Stream Connection Diagnosis](./stream_connection_diagnosis.md) - é€£æ¥è¨ºæ–·

---

**æ–‡æª”çµæŸ**
